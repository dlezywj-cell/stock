<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡ç¥¨ä¼°å€¼ç³»ç»Ÿ (ç§»åŠ¨ç«¯æŠ˜å ç‰ˆ)</title>
    <style>
        /* === å…¨å±€é‡ç½®ä¸åŸºç¡€ === */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif; padding: 10px; max-width: 100%; margin: 0 auto; background-color: #f4f6f9; font-size: 13px; color: #333; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        
        /* === ç§»åŠ¨ç«¯ä¸“å±å¯¼èˆªæ  (é»˜è®¤éšè—ï¼Œæ‰‹æœºæ˜¾ç¤º) === */
        #mobile-nav { display: none; justify-content: space-between; align-items: center; background: #fff; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        #mobile-nav h3 { margin: 0; color: #2c3e50; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        #mobile-status { font-size: 11px; color: #007bff; font-family: monospace; }
        .btn-menu { background: #f8f9fa; border: 1px solid #ddd; color: #333; padding: 6px 12px; border-radius: 4px; font-size: 14px; }

        /* === å¯æŠ˜å åŒºåŸŸåŒ…è£…å™¨ (Desktopé»˜è®¤æ˜¾ç¤º) === */
        #top-area { display: block; transition: all 0.3s ease; flex-shrink: 0; }

        /* === åŸæœ‰é¡¶éƒ¨å’Œæ§åˆ¶æ  === */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h2 { margin: 0; border-left: 5px solid #007bff; padding-left: 10px; color: #2c3e50; font-size: 18px; }

        .control-bar { 
            margin-bottom: 10px; display: flex; gap: 8px; align-items: center; 
            background: #fff; padding: 8px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            flex-wrap: wrap; 
        }
        .divider { border-left: 1px solid #eee; height: 20px; margin: 0 2px; }

        /* === å½•å…¥é¢æ¿ === */
        #input-container { background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; transition: all 0.3s ease; margin-bottom: 10px; display: none; }
        #input-panel { padding: 15px; border-top: 3px solid #007bff; }
        .input-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; margin-bottom: 10px; }
        
        .group-box { border: 1px solid #e9ecef; padding: 10px; border-radius: 6px; background: #f8f9fa; display: flex; gap: 8px; flex-wrap: wrap; }
        .group-title { font-weight: bold; color: #555; margin-right: 5px; display: block; margin-bottom: 5px; font-size: 12px;}
        
        label { font-size: 12px; color: #666; display: block; margin-bottom: 2px; font-weight: 500; }
        input { padding: 5px 6px; border: 1px solid #ced4da; border-radius: 4px; width: 80px; transition: border-color 0.2s; }
        input:focus { border-color: #007bff; outline: none; }
        input[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }
        
        /* æŒ‰é’®é€šç”¨ */
        button { padding: 6px 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; transition: all 0.2s; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
        button:hover { opacity: 0.85; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); }

        /* æŒ‰é’®é…è‰² */
        .btn-search { background-color: #17a2b8; color: white; }
        .btn-add { background-color: #28a745; color: white; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-log { background-color: #6f42c1; color: white; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-cloud-pull { background-color: #6610f2; color: white; } 
        .btn-cloud-push { background-color: #fd7e14; color: white; }
        .btn-control { background-color: #6c757d; color: white; }
        .btn-toggle { background-color: #f8f9fa; border: 1px solid #ccc; color: #333; margin-right: 10px; }
        .btn-find { background-color: #fd7e14; color: white; }
        .btn-view { background-color: #e9ecef; color: #adb5bd; border: 1px solid transparent; }
        .btn-view.active { background-color: #007bff; color: white; border-color: #007bff; }
        .btn-compare { background-color: #6f42c1; color: white; }
        .btn-compare.active { background-color: #4a2c85; box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); }
        .btn-reset-all { background-color: #6c757d; color: white; }
        .btn-confirm-del { background-color: #dc3545; color: white; font-size: 14px; padding: 8px 25px; }
        .btn-cancel { background-color: #6c757d; color: white; font-size: 14px; padding: 8px 25px; }

        /* === è¡¨æ ¼åŒºåŸŸ (æ ¸å¿ƒ) === */
        #result { 
            background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            border: 1px solid #e9ecef; flex-grow: 1; overflow: auto; position: relative; 
        }
        table { border-collapse: separate; border-spacing: 0; width: 100%; min-width: 1200px; }
        th, td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #ebebeb; border-right: 1px solid #ebebeb; white-space: nowrap; }
        
        /* åŒè¡Œé”å®šé€»è¾‘ */
        th { background-color: #f1f3f5; color: #495057; font-weight: 700; user-select: none; position: sticky; z-index: 20; }
        thead tr:nth-child(1) th { top: 0; border-bottom: 1px solid #ccc; height: 22px; }
        thead tr:nth-child(2) th { top: 43px; box-shadow: 0 2px 2px rgba(0,0,0,0.05); }
        
        /* é¦–åˆ—é”å®š */
        tbody td:first-child { position: sticky; left: 0; z-index: 15; background-color: #fff; border-right: 2px solid #d1d1d1; }
        tbody tr:nth-child(even) td:first-child { background-color: #f8f9fa; }
        tbody tr:hover td:first-child { background-color: #e9ecef; }
        /* äº¤å‰ç‚¹é”å®š */
        thead tr:nth-child(1) th:first-child { position: sticky; left: 0; top: 0; z-index: 30; border-right: 2px solid #d1d1d1; }
        thead tr:nth-child(2) th:first-child { position: sticky; left: 0; top: 43px; z-index: 30; border-right: 2px solid #d1d1d1; }
        
        .col-hidden { display: none !important; }
        .tag-badge { display: inline-block; background: #e7f5ff; color: #007bff; padding: 2px 5px; border-radius: 3px; font-size: 10px; margin: 1px; border: 1px solid #d0ebff; }
        .th-basic { border-top: 3px solid #6c757d; }
        .th-pe { border-top: 3px solid #28a745; background-color: #f3fdf6; }
        .th-ps { border-top: 3px solid #fd7e14; background-color: #fff8f3; }
        
        .th-select { border-top: 3px solid #adb5bd; border-left: 2px solid #dee2e6 !important; background-color: #e9ecef; width: 35px !important; padding: 0 !important; cursor: pointer; z-index: 25; }
        .td-select { border-left: 2px solid #dee2e6 !important; background-color: #f8f9fa; width: 35px !important; padding: 0 !important; cursor: pointer; }
        
        .row-checkbox { cursor: pointer; accent-color: #007bff; width: 16px; height: 16px; margin: 0 auto; display: block; }
        .filter-icon { font-size: 12px; color: #adb5bd; cursor: pointer; margin-left: 2px; }
        .filter-active { color: #dc3545 !important; font-weight: bold; background-color: #f8d7da; border-radius:2px; padding:0 2px; }

        #filter-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 6px; padding: 12px; z-index: 3000; min-width: 200px; }
        #filter-menu h4 { margin: 0 0 10px 0; font-size: 13px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #333; }
        .filter-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .filter-row input { padding: 4px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1; width: 100%;}
        .filter-actions { display: flex; justify-content: flex-end; gap: 8px; }
        
        .row-selected { background-color: #e8f0fe !important; }
        .row-selected td:first-child { background-color: #e8f0fe !important; } 
        
        .data-empty { color: #ccc; font-weight: normal; }
        #status-msg { font-size: 12px; color: #007bff; margin-left: 10px; font-family: monospace; }
        .sort-icon { font-size: 10px; margin-left: 2px; color: #adb5bd; }
        .sort-active { color: #007bff; }

        /* å¼¹çª— */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); justify-content: center; align-items: center; }
        #delete-modal { z-index: 2200; } #sync-modal { z-index: 2100; } #log-modal { z-index: 2000; }
        .modal-content { background-color: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; max-height: 80vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        
        .log-entry { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 12px; color: #444; }
        .log-time { color: #999; font-size: 12px; margin-bottom: 2px; }
        .log-note { display: block; margin-top: 4px; color: #555; background: #fff3cd; padding: 4px 8px; border-radius: 4px; border-left: 3px solid #ffc107; }
        .log-del-btn { cursor: pointer; color: #dc3545; opacity: 0.6; font-size: 14px; padding: 2px 8px; }
        
        /* åŒæ­¥å¼¹çª— */
        .sync-info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f1f1; }
        .sync-val.new { color: #28a745; } .sync-val.old { color: #dc3545; }

        /* â˜…â˜…â˜… ç§»åŠ¨ç«¯é€‚é…æ ¸å¿ƒ CSS â˜…â˜…â˜… */
        @media (max-width: 768px) {
            /* 1. æ˜¾ç¤ºç§»åŠ¨ç«¯å¯¼èˆªæ  */
            #mobile-nav { display: flex; }
            
            /* 2. é»˜è®¤éšè—é¡¶éƒ¨æ§åˆ¶åŒº */
            #top-area { display: none; }
            
            /* 3. å±•å¼€çŠ¶æ€çš„æ ·å¼ */
            #top-area.show { display: block; animation: slideDown 0.2s ease-out; }
            
            /* 4. è°ƒæ•´ header-bar å’Œ control-bar åœ¨æ‰‹æœºä¸Šçš„æ˜¾ç¤º */
            .header-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-bar h2 { display: none; } /* æ‰‹æœºä¸Šæ ‡é¢˜å·²ç»åœ¨ mobile-nav æ˜¾ç¤ºäº†ï¼Œè¿™é‡Œéšè— */
            .header-bar div { width: 100%; display: flex; justify-content: space-between; }
            
            .control-bar { flex-direction: column; align-items: stretch; }
            .control-bar > * { width: 100%; margin-bottom: 5px; }
            .control-bar input { width: 100% !important; box-sizing: border-box; }
            .control-bar .divider { display: none; }
            
            /* æŒ‰é’®ç»„è°ƒæ•´ */
            .control-bar button { justify-content: center; padding: 10px; font-size: 14px; }
            
            /* å½•å…¥é¢æ¿è°ƒæ•´ */
            #input-panel { padding: 10px; }
            .group-box { width: 100%; box-sizing: border-box; }
            .input-row { flex-direction: column; gap: 0; }
        }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- â˜…â˜…â˜… ç§»åŠ¨ç«¯ä¸“å±å¯¼èˆªæ  â˜…â˜…â˜… -->
    <div id="mobile-nav">
        <h3>ğŸ“ˆ ä¼°å€¼ç³»ç»Ÿ <span id="mobile-status"></span></h3>
        <button class="btn-menu" onclick="toggleMobileMenu()" id="mobile-menu-btn">âš™ï¸ èœå•</button>
    </div>

    <!-- â˜…â˜…â˜… å¯æŠ˜å åŒºåŸŸå®¹å™¨ â˜…â˜…â˜… -->
    <div id="top-area">
        <div class="header-bar">
            <h2>ğŸ“ˆ è‚¡ç¥¨ä¼°å€¼å¤ç›˜ç³»ç»Ÿ</h2>
            <div style="width: 100%; display:flex; gap:5px; flex-wrap:wrap;">
                <span id="status-msg" style="display:none;"></span> <!-- PCç«¯Statusåœ¨JSé‡Œå¤„ç†ï¼ŒMobileç”¨mobile-status -->
                <button class="btn-cloud-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–</button>
                <button class="btn-cloud-push" onclick="uploadToGithub()">ğŸš€ ä¸Šä¼ </button>
                <span style="flex-grow:1"></span>
                <button class="btn-control" onclick="startRealtime()">â–¶ å¼€å¯</button>
                <button class="btn-control" onclick="stopRealtime()">â¹ æš‚åœ</button>
            </div>
        </div>

        <div class="control-bar">
            <button class="btn-toggle" onclick="toggleInputPanel()" id="toggle-btn">â• å½•å…¥/ç®¡ç†</button>
            
            <div style="display:flex; gap:5px; width:100%">
                <input type="text" id="findInput" placeholder="ä»£ç /åç§°" onkeydown="if(event.keyCode==13) updateTable()">
                <input type="text" id="findTags" placeholder="å±æ€§/èµ›é“" onkeydown="if(event.keyCode==13) updateTable()">
                <button class="btn-find" onclick="updateTable()" style="width:auto;">Go</button>
            </div>

            <div style="display:flex; gap:5px; width:100%; flex-wrap: wrap;">
                <button class="btn-reset-all" onclick="clearAllFilters()">ğŸŒªï¸ é‡ç½®</button>
                <button class="btn-compare" id="btn-compare" onclick="toggleShowSelected()">ğŸ“Š é€‰ä¸­ (0)</button>
            </div>
            
            <!-- ç”µè„‘ç«¯æ˜¾ç¤ºæŒ‰é’®ç»„ (æ‰‹æœºç«¯å¯ä»¥ç”¨ CSS éšè—æˆ–è€…æŠ˜å ï¼Œè¿™é‡Œä¿ç•™) -->
            <div style="display:flex; gap:5px; flex-wrap:wrap; justify-content: space-between;">
                <button class="btn-view active" id="btn-toggle-code" onclick="toggleColumn('code')">ä»£ç </button>
                <button class="btn-view active" id="btn-toggle-tags" onclick="toggleColumn('tags')">å±æ€§</button>
                <button class="btn-view active" id="btn-toggle-update" onclick="toggleColumn('update')">æ›´æ–°</button>
                <button class="btn-view active" id="btn-toggle-action" onclick="toggleColumn('action')">æ“ä½œ</button>
            </div>
        </div>

        <!-- å½•å…¥é¢æ¿ -->
        <div id="input-container">
            <div id="input-panel">
                <input type="hidden" id="editCode" value="">
                <div class="input-row">
                    <div class="group-box" style="background: #fff; border-color: #ddd;">
                        <div style="display:flex; gap:5px; width:100%; align-items:center;">
                            <label style="width:40px;">åç§°</label>
                            <input type="text" id="inName" placeholder="è…¾è®¯" style="flex:1">
                            <button class="btn-search" onclick="searchStockCode()">ğŸ”</button>
                        </div>
                        <div style="display:flex; gap:5px; width:100%; align-items:center; margin-top:5px;">
                            <label style="width:40px;">ä»£ç </label>
                            <input type="text" id="inCode" readonly placeholder="è‡ªåŠ¨" style="flex:1; background:#eee">
                        </div>
                        <input type="text" id="inTags" placeholder="å±æ€§ (ç©ºæ ¼åˆ†éš”)" style="width: 100%; margin-top:5px;">
                        <input type="text" id="inNote" placeholder="å¤‡æ³¨ (æ—¥å¿—)" style="width: 100%; margin-top:5px;">
                    </div>
                </div>
                <div class="input-row">
                    <div class="group-box" style="border-left: 4px solid #28a745;">
                        <div style="width:100%; font-weight:bold; color:#28a745; margin-bottom:5px;">â‘  PE ä¼°å€¼</div>
                        <div style="display:flex; justify-content:space-between; width:100%">
                            <div><label>å‡€åˆ©</label><input type="number" id="inProfit" step="0.1" style="width:60px"></div>
                            <div><label>PEä¸‹</label><input type="number" id="inLowPE" style="width:40px"></div>
                            <div><label>PEä¸Š</label><input type="number" id="inHighPE" style="width:40px"></div>
                        </div>
                    </div>
                    <div class="group-box" style="border-left: 4px solid #fd7e14;">
                        <div style="width:100%; font-weight:bold; color:#fd7e14; margin-bottom:5px;">â‘¡ PS ä¼°å€¼</div>
                        <div style="display:flex; justify-content:space-between; width:100%">
                            <div><label>è¥æ”¶</label><input type="number" id="inRevenue" step="0.1" style="width:60px"></div>
                            <div><label>PSä¸‹</label><input type="number" id="inLowPS" style="width:40px"></div>
                            <div><label>PSä¸Š</label><input type="number" id="inHighPS" style="width:40px"></div>
                        </div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn-add" onclick="saveStock()" id="btn-save-text" style="padding:10px 30px; font-size:14px;">ğŸ’¾ ä¿å­˜</button>
                    <button onclick="clearInput()" style="padding:10px 20px; margin-left:10px;">é‡ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result"></div>

    <!-- å¼¹çª— (ä¿æŒä¸å˜) -->
    <div id="filter-menu">
        <h4 id="filter-title">ç­›é€‰æ¡ä»¶</h4>
        <div class="filter-row" id="filter-row-numeric">
            <select id="filter-op"><option value=">"> > </option><option value="<"> < </option><option value=">="> â‰¥ </option><option value="<="> â‰¤ </option><option value="="> = </option></select>
            <input type="number" id="filter-val" placeholder="æ•°å€¼">
        </div>
        <div class="filter-row" id="filter-row-text" style="display:none;">
            <input type="text" id="filter-text-val" placeholder="åŒ…å«...">
        </div>
        <div class="filter-actions"><button class="btn-cancel" onclick="clearCurrentFilter()" style="padding:4px 10px;">æ¸…ç©º</button><button class="btn-add" onclick="confirmFilter()" style="padding:4px 10px;">ç¡®å®š</button></div>
        <input type="hidden" id="filter-col-key">
    </div>

    <div id="log-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeLogModal()">&times;</span><h3 id="modal-title" style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:15px;">æ—¥å¿—</h3><div id="modal-body"></div></div></div>
    <div id="delete-modal" class="modal"><div class="modal-content" style="text-align: center; padding-top: 30px;"><h3>âš ï¸ ç¡®è®¤åˆ é™¤ï¼Ÿ</h3><p id="delete-msg" style="color:#555; margin-bottom:30px;">...</p><div><button class="btn-confirm-del" onclick="confirmDeleteAction()">åˆ é™¤</button><button class="btn-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button></div></div></div>
    <div id="sync-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeSyncModal()">&times;</span><h3 style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:15px;">â˜ï¸ åŒæ­¥ç¡®è®¤</h3><div style="padding: 10px 0;"><div class="sync-info-row"><span class="sync-label">äº‘ç«¯:</span><span class="sync-val" id="sync-cloud-date">...</span></div><div class="sync-info-row"><span class="sync-label">æœ¬åœ°:</span><span class="sync-val" id="sync-local-date">...</span></div><div class="sync-info-row"><span class="sync-label">æ•°é‡:</span><span class="sync-val" id="sync-count">...</span></div></div><div style="text-align:right; margin-top:20px;"><button class="btn-cloud-pull" onclick="confirmSyncAction()" style="padding:8px 20px;">âœ… è¦†ç›–</button><button class="btn-cancel" onclick="closeSyncModal()" style="padding:8px 20px;">å–æ¶ˆ</button></div></div></div>

    <script>
        // â˜…â˜…â˜… ç§»åŠ¨ç«¯èœå•åˆ‡æ¢é€»è¾‘ â˜…â˜…â˜…
        function toggleMobileMenu(forceState) {
            const area = document.getElementById('top-area');
            const btn = document.getElementById('mobile-menu-btn');
            const isHidden = area.style.display === 'none' || getComputedStyle(area).display === 'none';
            
            // å¦‚æœ forceState æœ‰å€¼ï¼Œåˆ™å¼ºåˆ¶è®¾ç½®ï¼›å¦åˆ™åˆ‡æ¢
            const shouldShow = forceState !== undefined ? forceState : isHidden;

            if (shouldShow) {
                area.style.display = 'block';
                area.classList.add('show');
                btn.innerText = 'ğŸ”¼ æ”¶èµ·';
            } else {
                area.style.display = 'none';
                area.classList.remove('show');
                btn.innerText = 'âš™ï¸ èœå•';
            }
        }

        // åˆå§‹åŒ–ï¼šå¦‚æœå±å¹•å°ï¼Œéšè—é¡¶éƒ¨
        if (window.innerWidth <= 768) {
            document.getElementById('top-area').style.display = 'none';
        }

        let stocks = JSON.parse(localStorage.getItem('valuationStocks')) || [];
        let defaultView = { showCode: true, showTags: true, showUpdate: true, showAction: true };
        let storedView = JSON.parse(localStorage.getItem('viewSettings')) || {};
        let viewSettings = { ...defaultView, ...storedView };
        
        let intervalId = null;
        let sortState = { key: 'pe_up', dir: 'desc' };
        let isPanelOpen = false;
        let pendingDeleteCode = null;
        let pendingLogIndex = null;
        let pendingSyncData = null;
        let cachedMarketData = {};
        let selectedCodes = new Set();
        let columnFilters = {}; 
        let onlySelectedMode = false;
        let currentVisibleStocks = [];

        updateViewButtons();

        const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "stock", path: "data.jason", branch: "main" };

        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

        async function uploadToGithub() {
            let token = localStorage.getItem("github_token");
            if (!token) { token = prompt("ğŸ”‘ è¯·è¾“å…¥ GitHub Token:"); if (!token) return; localStorage.setItem("github_token", token); }
            const btn = document.querySelector('.btn-cloud-push');
            const originText = btn.innerText;
            btn.innerText = "â³..."; btn.disabled = true;
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
            try {
                const getRes = await fetch(apiUrl, { headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" }, cache: "no-store" });
                let sha = null; if (getRes.ok) { const fileData = await getRes.json(); sha = fileData.sha; } else if (getRes.status !== 404) throw new Error(`API: ${getRes.status}`);
                btn.innerText = "ğŸš€...";
                const putRes = await fetch(apiUrl, { method: "PUT", headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" }, body: JSON.stringify({ message: `Update ${new Date().toLocaleString()}`, content: utf8_to_b64(JSON.stringify(stocks, null, 2)), branch: GITHUB_CONFIG.branch, sha: sha }) });
                if (putRes.ok) alert("âœ… æˆåŠŸ"); else throw new Error((await putRes.json()).message);
            } catch (e) { if (e.message.includes("401")) { alert("âŒ Tokenå¤±æ•ˆ"); localStorage.removeItem("github_token"); } else alert(`âŒ ${e.message}`); } 
            finally { btn.innerText = originText; btn.disabled = false; }
        }

        async function syncFromGithub() {
            let token = localStorage.getItem("github_token");
            const btn = document.querySelector('.btn-cloud-pull');
            const originText = btn.innerText;
            btn.innerText = "âŒ›..."; btn.disabled = true;
            try {
                let newData = null;
                const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
                const headers = { "Accept": "application/vnd.github.v3+json" };
                if (token) headers["Authorization"] = `token ${token}`;
                const res = await fetch(apiUrl, { headers, cache: "no-store" });
                if (res.ok) { const json = await res.json(); newData = JSON.parse(b64_to_utf8(json.content)); } 
                else {
                    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}`;
                    const resRaw = await fetch(rawUrl + "?t=" + Date.now());
                    if (!resRaw.ok) throw new Error("æ— æ³•è®¿é—®");
                    newData = await resRaw.json();
                }
                if (Array.isArray(newData)) {
                    pendingSyncData = newData;
                    const cloudDate = newData.length > 0 && newData[0].logs?.length ? newData[0].logs[0].date : "æ— ";
                    const localDate = stocks.length > 0 && stocks[0].logs?.length ? stocks[0].logs[0].date : "æ— ";
                    document.getElementById('sync-cloud-date').innerText = cloudDate;
                    document.getElementById('sync-local-date').innerText = localDate;
                    document.getElementById('sync-count').innerText = `${newData.length} vs ${stocks.length}`;
                    const cDate = document.getElementById('sync-cloud-date');
                    if(cloudDate > localDate) { cDate.className = "sync-val new"; cDate.innerText += " (æ–°)"; }
                    else if(cloudDate < localDate) { cDate.className = "sync-val old"; cDate.innerText += " (æ—§)"; }
                    else { cDate.className = "sync-val"; }
                    document.getElementById('sync-modal').style.display = 'flex';
                }
            } catch (e) { alert(`âŒ ${e.message}`); } 
            finally { btn.innerText = originText; btn.disabled = false; }
        }
        function confirmSyncAction() { if(pendingSyncData) { stocks = pendingSyncData; saveStorage(); updateTable(); closeSyncModal(); } }
        function closeSyncModal() { document.getElementById('sync-modal').style.display = 'none'; pendingSyncData = null; }

        function getSecid(code) { if (code.endsWith('.SH')) return `1.${code.replace('.SH','')}`; if (code.endsWith('.SZ')) return `0.${code.replace('.SZ','')}`; if (code.endsWith('.HK')) return `116.${code.replace('.HK','')}`; return `105.${code}`; }

        async function updateTable() {
            const container = document.getElementById('result');
            const mobileStatus = document.getElementById('mobile-status');
            const pcStatus = document.getElementById('status-msg');
            
            if (stocks.length === 0) { container.innerHTML = '<div style="padding:40px;text-align:center;color:#999;">ğŸ“­ åˆ—è¡¨ä¸ºç©º</div>'; mobileStatus.innerText=""; return; }
            const secids = stocks.map(s => getSecid(s.code)).join(',');
            const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secids}&fields=f12,f14,f2,f3,f18,f20&invt=2&fltt=2&_=${Date.now()}`;
            try {
                const res = await fetch(url);
                const json = await res.json();
                if (json?.data?.diff) { 
                    (Array.isArray(json.data.diff) ? json.data.diff : Object.values(json.data.diff)).forEach(item => { cachedMarketData[item.f12] = item; }); 
                    const timeStr = new Date().toLocaleTimeString();
                    mobileStatus.innerText = `â— ${timeStr}`; 
                    pcStatus.innerText = `â— å·²æ›´æ–° ${timeStr}`;
                }
            } catch (e) { mobileStatus.innerText = "âš ï¸"; }
            
            const data = stocks.map(s => {
                const rawCode = s.code.split('.')[0]; const mItem = cachedMarketData[rawCode]; let market = { cap: 0, chg: 0, valid: false };
                if (mItem) { let p = parseFloat(mItem.f2), last = parseFloat(mItem.f18), mCap = parseFloat(mItem.f20), chgPct = parseFloat(mItem.f3); market.cap = (mCap > 0 ? mCap : 0) / 100000000; market.chg = !isNaN(chgPct) ? chgPct.toFixed(2) : "0.00"; market.valid = true; }
                let peRes = { down: '-', up: '-' }, psRes = { down: '-', up: '-' };
                if (market.valid && market.cap > 0) {
                    if (s.profit && s.lowPE) { peRes.down = ((s.profit * s.lowPE / market.cap - 1) * 100).toFixed(2); peRes.up = ((s.profit * s.highPE - market.cap) / market.cap * 100).toFixed(2); }
                    if (s.revenue && s.lowPS) { psRes.down = ((s.revenue * s.lowPS / market.cap - 1) * 100).toFixed(2); psRes.up = ((s.revenue * s.highPS - market.cap) / market.cap * 100).toFixed(2); }
                }
                return { ...s, ...market, peRes, psRes };
            });
            renderTable(data); updateCompareBtn();
        }

        function renderTable(data) {
            const container = document.getElementById('result');
            let filteredData = data.filter(item => {
                if (onlySelectedMode && !selectedCodes.has(item.code)) return false;
                const searchKey = document.getElementById('findInput').value.trim().toUpperCase();
                if (searchKey && !item.code.includes(searchKey) && !item.name.includes(searchKey)) return false;
                const searchTags = document.getElementById('findTags').value.trim().toLowerCase();
                if (searchTags) { const itemTags = (item.tags || "").toLowerCase(); if (!searchTags.split(/\s+/).every(k => itemTags.includes(k))) return false; }
                for (let colKey in columnFilters) {
                    const rule = columnFilters[colKey]; if (!rule) continue;
                    if (rule.type === 'text') { if (!(item[colKey] || "").toLowerCase().includes(rule.val.toLowerCase())) return false; } 
                    else {
                        let val = -999999;
                        if (colKey === 'pe_down') val = parseFloat(item.peRes.down); else if (colKey === 'pe_up') val = parseFloat(item.peRes.up); else if (colKey === 'ps_down') val = parseFloat(item.psRes.down); else if (colKey === 'ps_up') val = parseFloat(item.psRes.up);
                        if (isNaN(val)) return false;
                        if(rule.op==='>'&&!(val>rule.val))return false; if(rule.op==='<'&&!(val<rule.val))return false; if(rule.op==='>='&&!(val>=rule.val))return false; if(rule.op==='<='&&!(val<=rule.val))return false; if(rule.op==='='&&Math.abs(val-rule.val)>0.1)return false;
                    }
                }
                return true;
            });
            currentVisibleStocks = filteredData;
            if (sortState.key) {
                filteredData.sort((a, b) => {
                    const getVal = (obj, k) => {
                        if(k=='chg') return parseFloat(obj.chg);
                        if(k.includes('pe')) return parseFloat(obj.peRes[k.split('_')[1]]) || -9999;
                        if(k.includes('ps')) return parseFloat(obj.psRes[k.split('_')[1]]) || -9999;
                        if(k==='last_update') return obj.logs?.length ? obj.logs[0].date : "0";
                        return 0;
                    };
                    return sortState.dir === 'desc' ? (getVal(b, sortState.key) > getVal(a, sortState.key) ? 1 : -1) : (getVal(a, sortState.key) > getVal(b, sortState.key) ? 1 : -1);
                });
            }
            const getFilterIcon = (key) => `<span class="${columnFilters[key]?'filter-icon filter-active':'filter-icon'}" onclick="event.stopPropagation(); openFilterMenu('${key}', event)">${columnFilters[key]?'â–¼':'â–½'}</span>`;
            const styleCode = viewSettings.showCode?'':'col-hidden'; const styleTags = viewSettings.showTags?'':'col-hidden'; const styleUpdate = viewSettings.showUpdate?'':'col-hidden'; const styleAction = viewSettings.showAction?'':'col-hidden';
            const isAllVisibleSelected = filteredData.length > 0 && filteredData.every(item => selectedCodes.has(item.code));
            
            let html = `<table><thead>
                    <tr>
                        <th class="th-basic" colspan="${3 + (viewSettings.showCode?1:0) + (viewSettings.showTags?1:0)}">ğŸ“Š åŸºç¡€è¡Œæƒ…</th>
                        <th class="th-pe" colspan="4">ğŸ’° PE ä¼°å€¼æ¨¡å‹ (åˆ©æ¶¦)</th>
                        <th class="th-ps" colspan="4">ğŸš€ PS ä¼°å€¼æ¨¡å‹ (è¥æ”¶)</th>
                        <th rowspan="2" class="sortable ${styleUpdate}" onclick="setSort('last_update')" style="width:70px;">ğŸ“… æ›´æ–° <span class="${getSortClass('last_update')}">${getSortIcon('last_update')}</span></th>
                        <th class="th-basic ${styleAction}" rowspan="2">âš™ï¸ æ“ä½œ</th>
                        <th class="th-select" rowspan="2" onclick="toggleSelectAll()"><input type="checkbox" ${isAllVisibleSelected ? 'checked' : ''}></th>
                    </tr>
                    <tr>
                        <th>åç§°</th>
                        <th class="${styleCode}">ä»£ç </th>
                        <th class="${styleTags}" style="max-width:150px;">å±æ€§ ${getFilterIcon('tags')}</th>
                        <th onclick="setSort('chg')" class="sortable">æ¶¨è·Œå¹… <span class="${getSortClass('chg')}">${getSortIcon('chg')}</span></th>
                        <th>å¸‚å€¼(äº¿)</th>
                        <th>é¢„æœŸå‡€åˆ©</th>
                        <th>åˆç†PE</th>
                        <th onclick="setSort('pe_down')" class="sortable">ä¸‹è¡Œ% ${getFilterIcon('pe_down')}</th>
                        <th onclick="setSort('pe_up')" class="sortable">ä¸Šè¡Œ% ${getFilterIcon('pe_up')}</th>
                        <th>é¢„æœŸè¥æ”¶</th>
                        <th>åˆç†PS</th>
                        <th onclick="setSort('ps_down')" class="sortable">ä¸‹è¡Œ% ${getFilterIcon('ps_down')}</th>
                        <th onclick="setSort('ps_up')" class="sortable">ä¸Šè¡Œ% ${getFilterIcon('ps_up')}</th>
                    </tr></thead><tbody>`;

            if(filteredData.length === 0) html += `<tr><td colspan="16" style="padding:30px;text-align:center;color:#999;">æ— æ•°æ®</td></tr>`;
            else filteredData.forEach(item => {
                const fmtPct = (v) => `<span style="color:${parseFloat(v)>=0?'#d32f2f':'#2e7d32'}; font-weight:${Math.abs(parseFloat(v))>30?'800':'bold'}">${v==='-'?'-':v+'%'}</span>`;
                const lastDateRaw = (item.logs && item.logs.length > 0) ? item.logs[0].date : '';
                let updateHtml = '<span class="data-empty" style="font-size:11px;">-</span>';
                if(lastDateRaw) updateHtml = `<span style="font-size:11px; color:#666;">${lastDateRaw.split(' ')[0]}<br><span style="color:#999; font-size:10px;">${lastDateRaw.split(' ')[1]||''}</span></span>`;
                const isChecked = selectedCodes.has(item.code) ? 'checked' : '';
                
                html += `<tr class="${isChecked?'row-selected':''}">
                    <td style="font-weight:600;">${item.name}</td>
                    <td class="${styleCode}" style="color:#868e96; font-size:12px;">${item.code}</td>
                    <td class="${styleTags}" style="text-align:left;">${item.tags?item.tags.split(' ').map(t=>`<span class="tag-badge">${t}</span>`).join(''):''}</td>
                    <td style="font-weight:bold; color:${parseFloat(item.chg)>=0 ? '#e03131':'#099268'}">${item.chg}%</td>
                    <td style="font-family:monospace;">${item.cap ? item.cap.toFixed(2) : '-'}</td>
                    <td>${item.profit||'-'}</td>
                    <td style="font-size:12px;">${item.lowPE||'-'}~${item.highPE||'-'}</td>
                    <td>${fmtPct(item.peRes.down)}</td>
                    <td>${fmtPct(item.peRes.up)}</td>
                    <td>${item.revenue||'-'}</td>
                    <td style="font-size:12px;">${item.lowPS||'-'}~${item.highPS||'-'}</td>
                    <td>${fmtPct(item.psRes.down)}</td>
                    <td>${fmtPct(item.psRes.up)}</td>
                    <td class="${styleUpdate}">${updateHtml}</td>
                    <td class="${styleAction}">
                        <button class="btn-log" onclick="showLogs('${item.code}')">ğŸ“</button>
                        <button class="btn-edit" onclick="editStock('${item.code}')">âœï¸</button>
                        <button class="btn-delete" onclick="openDeleteModal('${item.code}')">âœ•</button>
                    </td>
                    <td class="td-select" onclick="toggleSelectRow('${item.code}')"><input type="checkbox" class="row-checkbox" ${isChecked}></td>
                </tr>`;
            });
            html += '</tbody></table>'; container.innerHTML = html;
        }

        function toggleSelectRow(code) { if (selectedCodes.has(code)) selectedCodes.delete(code); else selectedCodes.add(code); updateTable(); }
        function toggleSelectAll() { if (currentVisibleStocks.length === 0) return; const allSelected = currentVisibleStocks.every(item => selectedCodes.has(item.code)); currentVisibleStocks.forEach(item => allSelected?selectedCodes.delete(item.code):selectedCodes.add(item.code)); updateTable(); }
        function clearAllFilters() { columnFilters = {}; document.getElementById('findInput').value = ''; document.getElementById('findTags').value = ''; if (onlySelectedMode) toggleShowSelected(); updateTable(); }
        function toggleShowSelected() { onlySelectedMode = !onlySelectedMode; const btn = document.getElementById('btn-compare'); if (onlySelectedMode) { btn.classList.add('active'); btn.innerText = "ğŸ”™ æ˜¾ç¤ºå…¨éƒ¨"; } else { btn.classList.remove('active'); updateCompareBtn(); } updateTable(); }
        function updateCompareBtn() { if (!onlySelectedMode) document.getElementById('btn-compare').innerText = `ğŸ“Š åªçœ‹é€‰ä¸­ (${selectedCodes.size})`; }
        function toggleColumn(c) { if(c=='code')viewSettings.showCode=!viewSettings.showCode; if(c=='tags')viewSettings.showTags=!viewSettings.showTags; if(c=='update')viewSettings.showUpdate=!viewSettings.showUpdate; if(c=='action')viewSettings.showAction=!viewSettings.showAction; localStorage.setItem('viewSettings',JSON.stringify(viewSettings)); updateViewButtons(); updateTable(); }
        function updateViewButtons() { const btnCode=document.getElementById('btn-toggle-code'), btnTags=document.getElementById('btn-toggle-tags'), btnUpdate=document.getElementById('btn-toggle-update'), btnAction=document.getElementById('btn-toggle-action'); if(viewSettings.showCode)btnCode.classList.add('active');else btnCode.classList.remove('active'); if(viewSettings.showTags)btnTags.classList.add('active');else btnTags.classList.remove('active'); if(viewSettings.showUpdate)btnUpdate.classList.add('active');else btnUpdate.classList.remove('active'); if(viewSettings.showAction)btnAction.classList.add('active');else btnAction.classList.remove('active'); }

        function openFilterMenu(colKey, e) { const m = document.getElementById('filter-menu'); m.style.display = 'block'; const r = e.target.getBoundingClientRect(); m.style.top = (window.scrollY + r.bottom + 5) + 'px'; m.style.left = Math.min(window.innerWidth - 230, (window.scrollX + r.left - 100)) + 'px'; document.getElementById('filter-col-key').value = colKey; const isText=colKey==='tags'; document.getElementById('filter-row-numeric').style.display=isText?'none':'flex'; document.getElementById('filter-row-text').style.display=isText?'flex':'none'; setTimeout(() => document.addEventListener('click', closeFilterMenuOutside), 0); }
        function closeFilterMenuOutside(e) { const m = document.getElementById('filter-menu'); if (!m.contains(e.target)) { m.style.display = 'none'; document.removeEventListener('click', closeFilterMenuOutside); } }
        function confirmFilter() { const k=document.getElementById('filter-col-key').value, isText=k==='tags'; if(isText){ const v=document.getElementById('filter-text-val').value.trim(); if(v)columnFilters[k]={type:'text',val:v};else delete columnFilters[k]; } else { const op=document.getElementById('filter-op').value, v=document.getElementById('filter-val').value; if(v)columnFilters[k]={type:'num',op,val:parseFloat(v)};else delete columnFilters[k]; } document.getElementById('filter-menu').style.display='none'; updateTable(); }
        function clearCurrentFilter() { delete columnFilters[document.getElementById('filter-col-key').value]; document.getElementById('filter-menu').style.display='none'; updateTable(); }

        function saveStock() {
            const code=document.getElementById('inCode').value.trim(), name=document.getElementById('inName').value.trim(), note=document.getElementById('inNote').value.trim(), tags=document.getElementById('inTags').value.trim();
            const p=parseFloat(document.getElementById('inProfit').value)||0, lpe=parseFloat(document.getElementById('inLowPE').value)||0, hpe=parseFloat(document.getElementById('inHighPE').value)||0;
            const rev=parseFloat(document.getElementById('inRevenue').value)||0, lps=parseFloat(document.getElementById('inLowPS').value)||0, hps=parseFloat(document.getElementById('inHighPS').value)||0;
            if(!code||!name){alert("è¯·å…ˆæœç´¢å¹¶åŒ¹é…è‚¡ç¥¨ä»£ç ï¼");return;}
            const now=new Date().toLocaleString('zh-CN',{hour12:false});
            let changes=[], newLog=null, stockData={code,name,tags,profit:p,lowPE:lpe,highPE:hpe,revenue:rev,lowPS:lps,highPS:hps,logs:[]};
            const idx=stocks.findIndex(s=>s.code===code);
            if(idx>=0){
                const old=stocks[idx]; stockData.logs=old.logs||[];
                if(old.profit!==p)changes.push(`å‡€åˆ©:${old.profit}â†’${p}`); if(old.lowPE!==lpe)changes.push(`PEä¸‹:${old.lowPE}â†’${lpe}`); if(old.highPE!==hpe)changes.push(`PEä¸Š:${old.highPE}â†’${hpe}`);
                if(old.revenue!==rev)changes.push(`è¥æ”¶:${old.revenue}â†’${rev}`); if(old.lowPS!==lps)changes.push(`PSä¸‹:${old.lowPS}â†’${lps}`); if(old.highPS!==hps)changes.push(`PSä¸Š:${old.highPS}â†’${hps}`);
                if((old.tags||"")!==tags)changes.push(`å±æ€§:${old.tags||""}â†’${tags}`);
                if(changes.length>0||note){ newLog={date:now, content:changes.length>0?changes.join('; '):"æ·»åŠ å¤‡æ³¨", note:note}; stockData.logs.unshift(newLog); }
                stocks[idx]=stockData;
            } else { newLog={date:now, content:"é¦–æ¬¡åˆ›å»º", note:note||"åˆå§‹åŒ–"}; stockData.logs.push(newLog); stocks.push(stockData); }
            saveStorage(); clearInput(); updateTable();
        }

        function showLogs(c) { 
            const s = stocks.find(i=>i.code===c); if(!s) return; 
            document.getElementById('modal-title').innerText = `${s.name} æ—¥å¿—`; 
            document.getElementById('modal-body').innerHTML = s.logs?.map((l, idx) => `
                <div class="log-entry">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="log-time">${l.date}</div>
                        <span class="log-del-btn" onclick="deleteLog('${c}', ${idx})" title="åˆ é™¤">ğŸ—‘ï¸</span>
                    </div>
                    <div class="log-change">${l.content}</div>
                    ${l.note ? `<span class="log-note">${l.note}</span>` : ''}
                </div>
            `).join('') || '<div style="text-align:center;padding:20px;color:#999">æ— è®°å½•</div>'; 
            document.getElementById('log-modal').style.display = 'flex'; 
        }
        
        function deleteLog(code, index) { pendingDeleteCode = code; pendingLogIndex = index; document.getElementById('delete-msg').innerText = `ç¡®è®¤åˆ é™¤è¿™æ¡æ—¥å¿—å—ï¼Ÿ`; document.getElementById('delete-modal').style.display = 'flex'; }
        window.openDeleteModal = function(c) { pendingDeleteCode = c; pendingLogIndex = null; document.getElementById('delete-msg').innerText = `ç¡®è®¤ä¸å†è·Ÿè¸ª ${c}?`; document.getElementById('delete-modal').style.display = 'flex'; };
        window.confirmDeleteAction = function() { 
            if(pendingDeleteCode) {
                if (pendingLogIndex !== null) { const s = stocks.find(item => item.code === pendingDeleteCode); if(s && s.logs) { s.logs.splice(pendingLogIndex, 1); saveStorage(); showLogs(pendingDeleteCode); updateTable(); } pendingLogIndex = null; } 
                else { stocks = stocks.filter(s => s.code !== pendingDeleteCode); selectedCodes.delete(pendingDeleteCode); saveStorage(); updateTable(); }
            } 
            closeDeleteModal(); 
        };
        function closeLogModal() { document.getElementById('log-modal').style.display='none'; }
        window.closeDeleteModal = function() { document.getElementById('delete-modal').style.display='none'; };
        
        function searchStockCode() { const name = document.getElementById('inName').value.trim(); if(!name) return; const btn = document.querySelector('.btn-search'); btn.innerText='...'; const sc = document.createElement('script'); window.handleSearch = function(d) { btn.innerText='ğŸ”'; if(d?.QuotationCodeTable?.Data?.length) { const r = d.QuotationCodeTable.Data[0]; let suf = r.MarketType=="1"?".SH":(r.MarketType=="2"?".SZ":(r.Code.length===5?".HK":"")); if(!suf && r.Code.length===6) suf = r.Code.startsWith('6')?".SH":".SZ"; document.getElementById('inCode').value = r.Code+suf; document.getElementById('inName').value = r.Name; } else { alert("æœªæ‰¾åˆ°"); } sc.remove(); }; sc.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(name)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=handleSearch`; document.body.appendChild(sc); }
        
        function editStock(c) { 
            // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œç¡®ä¿èœå•å·²å±•å¼€
            if (window.innerWidth <= 768) toggleMobileMenu(true);
            else if (!isPanelOpen) toggleInputPanel();
            
            const container = document.getElementById('input-container'); 
            // ç¡®ä¿å®¹å™¨å¯è§
            container.style.display = 'block';
            
            // æ»šåŠ¨
            container.scrollIntoView({ behavior: 'smooth', block: 'start' }); 
            
            const s=stocks.find(i=>i.code===c); if(!s)return; 
            document.getElementById('inName').value=s.name; document.getElementById('inCode').value=s.code; document.getElementById('inTags').value=s.tags||''; document.getElementById('inProfit').value=s.profit||''; document.getElementById('inLowPE').value=s.lowPE||''; document.getElementById('inHighPE').value=s.highPE||''; document.getElementById('inRevenue').value=s.revenue||''; document.getElementById('inLowPS').value=s.lowPS||''; document.getElementById('inHighPS').value=s.highPS||''; document.getElementById('btn-save-text').innerText="ğŸ’¾ ä¿®æ”¹"; 
        }
        
        function toggleInputPanel() { const c=document.getElementById('input-container'); isPanelOpen=!isPanelOpen; c.style.display=isPanelOpen?'block':'none'; document.getElementById('toggle-btn').innerText=isPanelOpen?'ğŸ”¼ æ”¶èµ·':'â• å½•å…¥/ç®¡ç†'; }
        function clearInput() { document.querySelectorAll('#input-panel input').forEach(i=>i.value=''); document.getElementById('editCode').value=''; document.getElementById('btn-save-text').innerText="ğŸ’¾ ä¿å­˜"; }

        function startRealtime() { if(!intervalId) { updateTable(); intervalId=setInterval(updateTable, 5000); document.getElementById('status-msg').innerText="â— å®æ—¶ä¸­"; document.getElementById('mobile-status').innerText="â—"; } }
        function stopRealtime() { clearInterval(intervalId); intervalId=null; document.getElementById('status-msg').innerText="â¸ æš‚åœ"; document.getElementById('mobile-status').innerText="â¸"; }
        function setSort(k) { if(sortState.key===k) sortState.dir=sortState.dir==='desc'?'asc':'desc'; else {sortState.key=k; sortState.dir='desc';} updateTable(); }
        function getSortIcon(k) { return sortState.key!==k?'':(sortState.dir==='desc'?'â¬‡':'â¬†'); }
        function getSortClass(k) { return sortState.key===k?'sort-icon sort-active':'sort-icon'; }
        function saveStorage() { localStorage.setItem('valuationStocks', JSON.stringify(stocks)); }
        window.onclick = function(e) { if(e.target.className==='modal') e.target.style.display='none'; }

        updateTable();
    </script>
</body>
</html>
