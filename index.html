<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨ä¼°å€¼ç³»ç»Ÿ (GitHubäº‘åŒæ­¥ç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; padding: 20px; max-width: 1700px; margin: 0 auto; background-color: #f4f6f9; font-size: 13px; color: #333; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { margin: 0; border-left: 5px solid #007bff; padding-left: 10px; color: #2c3e50; }

        .control-bar { 
            margin-bottom: 10px; display: flex; gap: 10px; align-items: center; 
            background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            flex-wrap: wrap;
        }
        .divider { border-left: 1px solid #eee; height: 20px; margin: 0 5px; }

        #input-container { background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; transition: all 0.3s ease; margin-bottom: 15px; display: none; }
        #input-panel { padding: 20px; border-top: 3px solid #007bff; }
        .input-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        
        .group-box { border: 1px solid #e9ecef; padding: 15px; border-radius: 6px; background: #f8f9fa; display: flex; gap: 10px; }
        .group-title { font-weight: bold; color: #555; margin-right: 5px; display: block; margin-bottom: 5px; font-size: 12px;}
        
        label { font-size: 12px; color: #666; display: block; margin-bottom: 4px; font-weight: 500; }
        input { padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px; width: 100px; transition: border-color 0.2s; }
        input:focus { border-color: #007bff; outline: none; }
        input[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }
        
        button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; transition: all 0.2s; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; }
        button:hover { opacity: 0.85; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: translateY(1px); }

        .btn-search { background-color: #17a2b8; color: white; }
        .btn-add { background-color: #28a745; color: white; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-log { background-color: #6f42c1; color: white; }
        .btn-delete { background-color: #dc3545; color: white; }
        
        /* äº‘åŒæ­¥æŒ‰é’®æ ·å¼ */
        .btn-cloud-pull { background-color: #6610f2; color: white; } /* ç´«è‰²ï¼šæ‹‰å– */
        .btn-cloud-push { background-color: #fd7e14; color: white; } /* æ©™è‰²ï¼šä¸Šä¼  */
        
        .btn-control { background-color: #6c757d; color: white; }
        .btn-toggle { background-color: #f8f9fa; border: 1px solid #ccc; color: #333; margin-right: 10px; }
        .btn-find { background-color: #fd7e14; color: white; }
        .btn-view { background-color: #e9ecef; color: #adb5bd; border: 1px solid transparent; }
        .btn-view.active { background-color: #007bff; color: white; border-color: #007bff; }
        .btn-compare { background-color: #6f42c1; color: white; }
        .btn-compare.active { background-color: #4a2c85; box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); }
        .btn-reset-all { background-color: #6c757d; color: white; }
        .btn-confirm-del { background-color: #dc3545; color: white; font-size: 14px; padding: 8px 25px; }
        .btn-cancel { background-color: #6c757d; color: white; font-size: 14px; padding: 8px 25px; }

        #result { overflow-x: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e9ecef; min-height: 300px; }
        table { border-collapse: collapse; width: 100%; min-width: 1300px; }
        th, td { padding: 10px 12px; text-align: center; border: 1px solid #ebebeb; white-space: nowrap; }
        th { background-color: #f1f3f5; color: #495057; font-weight: 700; user-select: none; position: sticky; top: 0; z-index: 10; }
        th.sortable:hover { background-color: #e2e6ea; cursor: pointer; color: #007bff; }
        tbody tr:nth-child(even) { background-color: #f8f9fa; } 
        tbody tr:hover { background-color: #e9ecef; transition: background-color 0.1s; }
        .col-hidden { display: none !important; }

        .tag-badge { display: inline-block; background: #e7f5ff; color: #007bff; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin: 1px; border: 1px solid #d0ebff; }
        .th-basic { border-top: 3px solid #6c757d; }
        .th-pe { border-top: 3px solid #28a745; background-color: #f3fdf6; }
        .th-ps { border-top: 3px solid #fd7e14; background-color: #fff8f3; }
        
        /* === æœ€åä¸€åˆ—ä¸“ç”¨æ ·å¼ï¼šçª„ã€åˆ†å‰²çº¿ã€å±…ä¸­ã€å¯ç‚¹å‡» === */
        .th-select { 
            border-top: 3px solid #adb5bd; 
            border-left: 2px solid #dee2e6 !important; /* æ˜æ˜¾çš„åˆ†å‰²çº¿ */
            background-color: #e9ecef;
            width: 40px !important;      
            max-width: 40px !important;
            padding: 0 !important;   
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
        }
        .th-select:hover { background-color: #dde2e6; }
        
        .td-select { 
            border-left: 2px solid #dee2e6 !important; /* æ˜æ˜¾çš„åˆ†å‰²çº¿ */
            background-color: #f8f9fa;
            width: 40px !important;
            max-width: 40px !important;
            padding: 0 !important;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
        }
        .td-select:hover { background-color: #e2e6ea; }
        
        /* å¤é€‰æ¡†æ ·å¼ */
        .row-checkbox { 
            cursor: pointer; 
            accent-color: #007bff; 
            width: 15px; 
            height: 15px; 
            margin: 0 auto; 
            display: block; 
        }

        .filter-icon { font-size: 12px; color: #adb5bd; cursor: pointer; padding: 2px 4px; margin-left: 4px; border-radius: 3px; transition: 0.2s; display: inline-block; }
        .filter-icon:hover { background-color: #ced4da; color: #333; }
        .filter-active { color: #dc3545 !important; font-weight: bold; background-color: #f8d7da; }

        #filter-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 6px; padding: 12px; z-index: 3000; min-width: 200px; }
        #filter-menu h4 { margin: 0 0 10px 0; font-size: 13px; border-bottom: 1px solid #eee; padding-bottom: 5px; color: #333; }
        .filter-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .filter-row select { padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
        .filter-row input { padding: 4px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1; }
        .filter-actions { display: flex; justify-content: flex-end; gap: 8px; }
        .filter-actions button { font-size: 12px; padding: 4px 10px; }
        
        .row-selected { background-color: #e8f0fe !important; }
        @keyframes highlightFade { 0% { background-color: #ffeb3b; } 100% { background-color: transparent; } }
        .row-highlight { animation: highlightFade 2.5s ease-out forwards; }
        .data-empty { color: #ccc; font-weight: normal; }
        #status-msg { font-size: 12px; color: #007bff; margin-left: 10px; font-family: monospace; }
        .sort-icon { font-size: 10px; margin-left: 4px; color: #adb5bd; }
        .sort-active { color: #007bff; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 25px; border-radius: 12px; width: 500px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); position: relative; animation: slideDown 0.2s ease-out; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
        .log-entry { border-bottom: 1px solid #eee; padding: 12px 0; font-size: 13px; color: #444; }
        .log-time { color: #999; font-size: 12px; margin-bottom: 4px; }
        .log-change { color: #2c3e50; font-weight: 600; }
        .log-note { display: block; margin-top: 6px; color: #555; background: #fff3cd; padding: 6px 10px; border-radius: 4px; border-left: 3px solid #ffc107; }
    </style>
</head>
<body>

    <div class="header-bar">
        <h2>ğŸ“ˆ è‚¡ç¥¨ä¼°å€¼å¤ç›˜ç³»ç»Ÿ</h2>
        <div>
            <span id="status-msg"></span>
            
            <!-- äº‘åŒæ­¥æŒ‰é’®ç»„ -->
            <button class="btn-cloud-pull" onclick="syncFromGithub()" title="ä»GitHubä¸‹è½½ data.jason è¦†ç›–æœ¬åœ°">â˜ï¸ æ‹‰å–æ•°æ®</button>
            <button class="btn-cloud-push" onclick="uploadToGithub()" title="å°†æœ¬åœ°æ•°æ®ä¸Šä¼ è¦†ç›–åˆ° GitHub">ğŸš€ ä¿å­˜åˆ° GitHub</button>
            
            <span style="border-left:1px solid #ccc; margin:0 10px; height:20px; display:inline-block; vertical-align:middle;"></span>
            <button class="btn-control" onclick="startRealtime()">â–¶ å¼€å¯</button>
            <button class="btn-control" onclick="stopRealtime()">â¹ æš‚åœ</button>
        </div>
    </div>

    <div class="control-bar">
        <button class="btn-toggle" onclick="toggleInputPanel()" id="toggle-btn">â• å½•å…¥/ç®¡ç†</button>
        
        <div class="divider"></div>
        <span style="font-size:12px; color:#666;">ğŸ”:</span>
        <input type="text" id="findInput" placeholder="ä»£ç /åç§°" style="width: 100px;" onkeydown="if(event.keyCode==13) updateTable()">
        <input type="text" id="findTags" placeholder="å±æ€§/èµ›é“" style="width: 100px;" onkeydown="if(event.keyCode==13) updateTable()">
        <button class="btn-find" onclick="updateTable()">Go</button>

        <div style="flex-grow:1"></div>
        
        <span class="control-label">ğŸ‘ï¸ æ˜¾ç¤º:</span>
        <button class="btn-view active" id="btn-toggle-code" onclick="toggleColumn('code')" title="æ˜¾ç¤º/éšè— ä»£ç åˆ—">ä»£ç </button>
        <button class="btn-view active" id="btn-toggle-tags" onclick="toggleColumn('tags')" title="æ˜¾ç¤º/éšè— å±æ€§åˆ—">å±æ€§</button>
        <button class="btn-view active" id="btn-toggle-update" onclick="toggleColumn('update')" title="æ˜¾ç¤º/éšè— æ›´æ–°åˆ—">æ›´æ–°</button>
        <button class="btn-view active" id="btn-toggle-action" onclick="toggleColumn('action')" title="æ˜¾ç¤º/éšè— æ“ä½œåˆ—">æ“ä½œ</button>

        <div class="divider"></div>
        
        <button class="btn-reset-all" onclick="clearAllFilters()" title="æ¸…é™¤æ‰€æœ‰ç­›é€‰ä¸æœç´¢">ğŸŒªï¸ é‡ç½®ç­›é€‰</button>
        <button class="btn-compare" id="btn-compare" onclick="toggleShowSelected()">ğŸ“Š åªçœ‹é€‰ä¸­ (0)</button>
    </div>

    <!-- å½•å…¥é¢æ¿ -->
    <div id="input-container">
        <div id="input-panel">
            <input type="hidden" id="editCode" value="">
            <div class="input-row">
                <div class="group-box" style="background: #fff; border-color: #ddd;">
                    <div><label>1. è‚¡ç¥¨åç§°</label><div style="display:flex; gap:5px;"><input type="text" id="inName" placeholder="å¦‚: è…¾è®¯" style="width:110px"><button class="btn-search" onclick="searchStockCode()">ğŸ” åŒ¹é…</button></div></div>
                    <div><label>2. ä»£ç  (è‡ªåŠ¨)</label><input type="text" id="inCode" readonly placeholder="ç­‰å¾…åŒ¹é…" style="width:90px"></div>
                    <div style="flex-grow: 1; min-width: 200px;"><label>ğŸ·ï¸ å±æ€§/èµ›é“ (ç©ºæ ¼åˆ†éš”)</label><input type="text" id="inTags" placeholder="å¦‚: æ¶ˆè´¹ç”µå­ åä¸ºé“¾ ç»©ä¼˜" style="width: 98%;"></div>
                    <div style="flex-grow: 1; min-width: 200px;"><label>ğŸ“ å¤‡æ³¨ (æ—¥å¿—ç”¨)</label><input type="text" id="inNote" placeholder="è¾“å…¥æƒ³æ³•ï¼Œå¦‚ï¼šè°ƒé«˜ä¼°å€¼ä¸Šé™" style="width: 98%;"></div>
                </div>
            </div>
            <div class="input-row">
                <div class="group-box" style="border-left: 4px solid #28a745;">
                    <div><span class="group-title" style="color:#28a745">â‘  PE ä¼°å€¼</span></div>
                    <div><label>å‡€åˆ©(äº¿)</label><input type="number" id="inProfit" step="0.1"></div>
                    <div><label>PEä¸‹é™</label><input type="number" id="inLowPE"></div>
                    <div><label>PEä¸Šé™</label><input type="number" id="inHighPE"></div>
                </div>
                <div class="group-box" style="border-left: 4px solid #fd7e14;">
                    <div><span class="group-title" style="color:#fd7e14">â‘¡ PS ä¼°å€¼</span></div>
                    <div><label>è¥æ”¶(äº¿)</label><input type="number" id="inRevenue" step="0.1"></div>
                    <div><label>PSä¸‹é™</label><input type="number" id="inLowPS" step="0.1"></div>
                    <div><label>PSä¸Šé™</label><input type="number" id="inHighPS" step="0.1"></div>
                </div>
                <div style="align-self: center;"><button class="btn-add" onclick="saveStock()" id="btn-save-text">ğŸ’¾ ä¿å­˜</button><button onclick="clearInput()" style="margin-left:5px;">é‡ç½®</button></div>
            </div>
        </div>
    </div>

    <div id="result"></div>

    <!-- æ‚¬æµ®ç­›é€‰èœå• -->
    <div id="filter-menu">
        <h4 id="filter-title">ç­›é€‰æ¡ä»¶</h4>
        <div class="filter-row" id="filter-row-numeric">
            <select id="filter-op"><option value=">">å¤§äº (>)</option><option value="<">å°äº (<)</option><option value=">=">å¤§ç­‰ (â‰¥)</option><option value="<=">å°ç­‰ (â‰¤)</option><option value="=">ç­‰äº (=)</option></select>
            <input type="number" id="filter-val" placeholder="æ•°å€¼">
        </div>
        <div class="filter-row" id="filter-row-text" style="display:none;">
            <input type="text" id="filter-text-val" placeholder="åŒ…å«çš„å†…å®¹...">
        </div>
        <div class="filter-actions"><button class="btn-cancel" onclick="clearCurrentFilter()" style="padding:4px 10px;">æ¸…ç©º</button><button class="btn-add" onclick="confirmFilter()" style="padding:4px 10px;">ç¡®å®š</button></div>
        <input type="hidden" id="filter-col-key">
    </div>

    <!-- å¼¹çª—åŒºåŸŸ -->
    <div id="log-modal" class="modal"><div class="modal-content" style="width: 600px;"><span class="close-btn" onclick="closeLogModal()">&times;</span><h3 id="modal-title" style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:15px;">æ“ä½œæ—¥å¿—</h3><div id="modal-body" style="max-height: 60vh; overflow-y: auto;"></div></div></div>
    <div id="delete-modal" class="modal"><div class="modal-content" style="width: 400px; text-align: center; padding-top: 30px;"><h3>âš ï¸ ç¡®è®¤åˆ é™¤ï¼Ÿ</h3><p id="delete-msg" style="color:#555; margin-bottom:30px;">...</p><div><button class="btn-confirm-del" onclick="confirmDeleteAction()">ç¡®å®šåˆ é™¤</button><button class="btn-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button></div></div></div>

    <script>
        // â˜…â˜…â˜… 1. åˆå§‹åŒ–é€»è¾‘ â˜…â˜…â˜…
        let stocks = JSON.parse(localStorage.getItem('valuationStocks')) || [];
        let defaultView = { showCode: true, showTags: true, showUpdate: true, showAction: true };
        let storedView = JSON.parse(localStorage.getItem('viewSettings')) || {};
        let viewSettings = { ...defaultView, ...storedView };
        
        let intervalId = null;
        let sortState = { key: 'pe_up', dir: 'desc' };
        let isPanelOpen = false;
        let pendingDeleteCode = null;
        let cachedMarketData = {};
        let selectedCodes = new Set();
        let columnFilters = {}; 
        let onlySelectedMode = false;
        let currentVisibleStocks = [];

        updateViewButtons();

        // ==========================================
        // â˜…â˜…â˜… é…ç½® GitHub ä¿¡æ¯ â˜…â˜…â˜…
        // ==========================================
        const GITHUB_CONFIG = {
            username: "dlezywj-cell",   // ç”¨æˆ·å
            repo: "stock",              // ä»“åº“å
            path: "data.jason",         // æ–‡ä»¶å (æ³¨æ„ä½ çš„æ˜¯ .jason)
            branch: "main"              // åˆ†æ”¯
        };

        // ------------------------------------------
        //  åŠŸèƒ½ 1: ä» GitHub æ‹‰å– (ä¸‹è½½)
        // ------------------------------------------
        async function syncFromGithub() {
            const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}`;
            const btn = document.querySelector('.btn-cloud-pull');
            const originText = btn.innerText;
            btn.innerText = "âŒ› ä¸‹è½½ä¸­...";
            btn.disabled = true;

            try {
                const res = await fetch(rawUrl + "?t=" + Date.now()); // é˜²ç¼“å­˜
                if (!res.ok) throw new Error("æ–‡ä»¶ä¸å­˜åœ¨æˆ–ç½‘ç»œé”™è¯¯");
                
                const newData = await res.json();

                if (Array.isArray(newData)) {
                    if(confirm(`â˜ï¸ æˆåŠŸä»äº‘ç«¯è·å– ${newData.length} æ¡æ•°æ®ã€‚\n\næ˜¯å¦è¦†ç›–å½“å‰æœ¬åœ°æ•°æ®ï¼Ÿ`)) {
                        stocks = newData;
                        saveStorage(); 
                        updateTable(); 
                        alert("âœ… åŒæ­¥å®Œæˆï¼");
                    }
                } else {
                    alert("âŒ æ•°æ®æ ¼å¼é”™è¯¯ï¼šä¸æ˜¯æ•°ç»„");
                }
            } catch (e) {
                console.error(e);
                alert(`âŒ æ‹‰å–å¤±è´¥: ${e.message}\nè¯·æ£€æŸ¥æ–‡ä»¶ data.jason æ˜¯å¦åœ¨ GitHub ä¸Šå­˜åœ¨ã€‚`);
            } finally {
                btn.innerText = originText;
                btn.disabled = false;
            }
        }

        // ------------------------------------------
        //  åŠŸèƒ½ 2: ä¸Šä¼ åˆ° GitHub (è‡ªåŠ¨æ›´æ–°)
        // ------------------------------------------
        function utf8_to_b64(str) {
            return window.btoa(unescape(encodeURIComponent(str)));
        }

        async function uploadToGithub() {
            // 1. è·å–/å­˜å‚¨ Token
            let token = localStorage.getItem("github_token");
            if (!token) {
                token = prompt("ğŸ”‘ é¦–æ¬¡ä¸Šä¼ éœ€è¦éªŒè¯æƒé™\n\nè¯·è¾“å…¥ GitHub Personal Access Token (ghp_...):\n(Tokenå°†ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ )");
                if (!token) return;
                localStorage.setItem("github_token", token);
            }

            const btn = document.querySelector('.btn-cloud-push');
            const originText = btn.innerText;
            btn.innerText = "â³ è¿æ¥ä¸­...";
            btn.disabled = true;

            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;

            try {
                // A. è·å–æ–‡ä»¶ SHA (æ›´æ–°æ–‡ä»¶å¿…é¡»æ­¥éª¤)
                const getRes = await fetch(apiUrl, {
                    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" }
                });

                let sha = null;
                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                } else if (getRes.status !== 404) {
                    throw new Error(`API é”™è¯¯: ${getRes.status}`);
                }

                // B. ä¸Šä¼ æ–°æ•°æ®
                btn.innerText = "ğŸš€ ä¸Šä¼ ä¸­...";
                const contentStr = JSON.stringify(stocks, null, 2);
                const putBody = {
                    message: `Update data ${new Date().toLocaleString()}`,
                    content: utf8_to_b64(contentStr),
                    branch: GITHUB_CONFIG.branch
                };
                if (sha) putBody.sha = sha;

                const putRes = await fetch(apiUrl, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(putBody)
                });

                if (putRes.ok) {
                    alert("âœ… ä¸Šä¼ æˆåŠŸï¼\nGitHubä¸Šçš„ data.jason å·²æ›´æ–°ã€‚");
                } else {
                    const err = await putRes.json();
                    throw new Error(err.message);
                }

            } catch (e) {
                console.error(e);
                if (e.message.includes("401") || e.message.includes("Bad credentials")) {
                    alert("âŒ Token æ— æ•ˆæˆ–è¿‡æœŸï¼Œå·²æ¸…é™¤æœ¬åœ°å­˜å‚¨ï¼Œè¯·é‡è¯•ã€‚");
                    localStorage.removeItem("github_token");
                } else {
                    alert(`âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`);
                }
            } finally {
                btn.innerText = originText;
                btn.disabled = false;
            }
        }

        function getSecid(code) {
            if (code.endsWith('.SH')) return `1.${code.replace('.SH','')}`;
            if (code.endsWith('.SZ')) return `0.${code.replace('.SZ','')}`;
            if (code.endsWith('.HK')) return `116.${code.replace('.HK','')}`;
            return `105.${code}`;
        }

        // ---------------- æ ¸å¿ƒï¼šæ•°æ®è·å–ä¸æ¸²æŸ“ ----------------
        async function updateTable() {
            const container = document.getElementById('result');
            const statusMsg = document.getElementById('status-msg');
            
            if (stocks.length === 0) {
                container.innerHTML = '<div style="padding:40px;text-align:center;color:#999;border:2px dashed #eee;border-radius:10px;">ğŸ“­ åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ·»åŠ è‚¡ç¥¨æˆ–ç‚¹å‡» "â˜ï¸ æ‹‰å–æ•°æ®"</div>';
                statusMsg.innerText = ""; return;
            }

            const secids = stocks.map(s => getSecid(s.code)).join(',');
            const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secids}&fields=f12,f14,f2,f3,f18,f20&invt=2&fltt=2&_=${Date.now()}`;

            try {
                const res = await fetch(url);
                const json = await res.json();
                if (json?.data?.diff) {
                    const list = Array.isArray(json.data.diff) ? json.data.diff : Object.values(json.data.diff);
                    list.forEach(item => { cachedMarketData[item.f12] = item; });
                    statusMsg.innerHTML = `â— æ•°æ®å·²æ›´æ–° ${new Date().toLocaleTimeString()}`;
                    statusMsg.style.color = "#007bff";
                }
            } catch (e) { statusMsg.innerHTML = `<span style="color:orange">âš ï¸ ç½‘ç»œæ³¢åŠ¨ï¼Œæ˜¾ç¤ºç¼“å­˜</span>`; }

            const data = stocks.map(s => {
                const rawCode = s.code.split('.')[0];
                const mItem = cachedMarketData[rawCode];
                let market = { cap: 0, chg: 0, valid: false };
                if (mItem) {
                    let p = parseFloat(mItem.f2); 
                    let last = parseFloat(mItem.f18);
                    let mCap = parseFloat(mItem.f20);
                    let chgPct = parseFloat(mItem.f3);
                    let validPrice = (p > 0) ? p : last;
                    let validCap = (mCap > 0) ? mCap : 0;
                    market.cap = validCap / 100000000; 
                    if (!isNaN(chgPct)) market.chg = chgPct.toFixed(2); else market.chg = "0.00";
                    market.valid = true;
                }
                let peRes = { down: '-', up: '-' };
                let psRes = { down: '-', up: '-' };
                if (market.valid && market.cap > 0) {
                    if (s.profit && s.lowPE) {
                        peRes.down = ((s.profit * s.lowPE / market.cap - 1) * 100).toFixed(2);
                        peRes.up = ((s.profit * s.highPE - market.cap) / market.cap * 100).toFixed(2);
                    }
                    if (s.revenue && s.lowPS) {
                        psRes.down = ((s.revenue * s.lowPS / market.cap - 1) * 100).toFixed(2);
                        psRes.up = ((s.revenue * s.highPS - market.cap) / market.cap * 100).toFixed(2);
                    }
                }
                return { ...s, ...market, peRes, psRes };
            });

            renderTable(data);
            updateCompareBtn();
        }

        function renderTable(data) {
            const container = document.getElementById('result');
            
            let filteredData = data.filter(item => {
                if (onlySelectedMode && !selectedCodes.has(item.code)) return false;
                const searchKey = document.getElementById('findInput').value.trim().toUpperCase();
                if (searchKey && !item.code.includes(searchKey) && !item.name.includes(searchKey)) return false;
                const searchTags = document.getElementById('findTags').value.trim().toLowerCase();
                if (searchTags) {
                    const itemTags = (item.tags || "").toLowerCase();
                    const keywords = searchTags.split(/\s+/); 
                    if (!keywords.every(k => itemTags.includes(k))) return false;
                }
                for (let colKey in columnFilters) {
                    const rule = columnFilters[colKey];
                    if (!rule) continue;
                    if (rule.type === 'text') {
                        const cellVal = (item[colKey] || "").toLowerCase();
                        if (!cellVal.includes(rule.val.toLowerCase())) return false;
                    } else {
                        let val = -999999;
                        if (colKey === 'pe_down') val = parseFloat(item.peRes.down);
                        else if (colKey === 'pe_up') val = parseFloat(item.peRes.up);
                        else if (colKey === 'ps_down') val = parseFloat(item.psRes.down);
                        else if (colKey === 'ps_up') val = parseFloat(item.psRes.up);
                        if (isNaN(val)) return false;
                        const limit = rule.val;
                        switch(rule.op) {
                            case '>': if (!(val > limit)) return false; break;
                            case '<': if (!(val < limit)) return false; break;
                            case '>=': if (!(val >= limit)) return false; break;
                            case '<=': if (!(val <= limit)) return false; break;
                            case '=': if (Math.abs(val - limit) > 0.1) return false; break;
                        }
                    }
                }
                return true;
            });
            
            currentVisibleStocks = filteredData;

            if (sortState.key) {
                filteredData.sort((a, b) => {
                    const getVal = (obj, k) => {
                        if(k=='chg') return parseFloat(obj.chg);
                        if(k.includes('pe')) return parseFloat(obj.peRes[k.split('_')[1]]) || -9999;
                        if(k.includes('ps')) return parseFloat(obj.psRes[k.split('_')[1]]) || -9999;
                        if(k==='last_update') {
                            const d1 = obj.logs && obj.logs.length > 0 ? obj.logs[0].date : "0";
                            const d2 = b.logs && b.logs.length > 0 ? b.logs[0].date : "0";
                            return sortState.dir === 'desc' ? (d1 < d2 ? 1 : -1) : (d1 > d2 ? 1 : -1);
                        }
                        return 0;
                    };
                    if (sortState.key === 'last_update') {
                        const d1 = a.logs && a.logs.length ? a.logs[0].date : "";
                        const d2 = b.logs && b.logs.length ? b.logs[0].date : "";
                        if(d1 === d2) return 0;
                        return sortState.dir === 'desc' ? (d1 < d2 ? 1 : -1) : (d1 > d2 ? 1 : -1);
                    }
                    return sortState.dir === 'desc' ? getVal(b, sortState.key) - getVal(a, sortState.key) : getVal(a, sortState.key) - getVal(b, sortState.key);
                });
            }

            const getFilterIcon = (key) => {
                const isActive = columnFilters[key] != null;
                const iconClass = isActive ? 'filter-icon filter-active' : 'filter-icon';
                const symbol = isActive ? 'â–¼' : 'â–½';
                return `<span class="${iconClass}" onclick="event.stopPropagation(); openFilterMenu('${key}', event)">${symbol}</span>`;
            };

            const styleCode = viewSettings.showCode ? '' : 'col-hidden';
            const styleTags = viewSettings.showTags ? '' : 'col-hidden';
            const styleUpdate = viewSettings.showUpdate ? '' : 'col-hidden';
            const styleAction = viewSettings.showAction ? '' : 'col-hidden';

            const isAllVisibleSelected = filteredData.length > 0 && filteredData.every(item => selectedCodes.has(item.code));
            const basicColsSpan = 3 + (viewSettings.showCode ? 1 : 0) + (viewSettings.showTags ? 1 : 0);

            let html = `
            <table>
                <thead>
                    <tr>
                        <th class="th-basic" colspan="${basicColsSpan}">ğŸ“Š åŸºç¡€è¡Œæƒ…</th>
                        <th class="th-pe" colspan="4">ğŸ’° PE ä¼°å€¼æ¨¡å‹ (åˆ©æ¶¦)</th>
                        <th class="th-ps" colspan="4">ğŸš€ PS ä¼°å€¼æ¨¡å‹ (è¥æ”¶)</th>
                        <th rowspan="2" class="sortable ${styleUpdate}" onclick="setSort('last_update')" style="vertical-align: middle; width:70px; font-size:12px;">
                            ğŸ“… æ›´æ–° <span class="${getSortClass('last_update')}">${getSortIcon('last_update')}</span>
                        </th>
                        <th class="th-basic ${styleAction}" rowspan="2" style="vertical-align: middle;">âš™ï¸ æ“ä½œ</th>
                        <th class="th-select" rowspan="2" onclick="toggleSelectAll()" title="ç‚¹å‡»å…¨é€‰/å–æ¶ˆ">
                            <div style="display:flex; flex-direction:column; align-items:center; cursor:pointer;">
                                <input type="checkbox" id="header-checkbox" ${isAllVisibleSelected ? 'checked' : ''} style="margin:0; cursor:pointer;">
                                <div style="font-size:9px; font-weight:normal; color:#888; line-height:1; margin-top:2px;">å…¨é€‰</div>
                            </div>
                        </th>
                    </tr>
                    <tr>
                        <th>åç§°</th>
                        <th class="${styleCode}">ä»£ç </th>
                        <th class="${styleTags}" style="max-width:150px;">å±æ€§ ${getFilterIcon('tags')}</th>
                        <th onclick="setSort('chg')" class="sortable">æ¶¨è·Œå¹… <span class="${getSortClass('chg')}">${getSortIcon('chg')}</span></th>
                        <th>å¸‚å€¼(äº¿)</th>
                        <th>é¢„æœŸå‡€åˆ©</th>
                        <th>åˆç†PE</th>
                        <th onclick="setSort('pe_down')" class="sortable">ä¸‹è¡Œ% ${getFilterIcon('pe_down')} <span class="${getSortClass('pe_down')}">${getSortIcon('pe_down')}</span></th>
                        <th onclick="setSort('pe_up')" class="sortable">ä¸Šè¡Œ% ${getFilterIcon('pe_up')} <span class="${getSortClass('pe_up')}">${getSortIcon('pe_up')}</span></th>
                        <th>é¢„æœŸè¥æ”¶</th>
                        <th>åˆç†PS</th>
                        <th onclick="setSort('ps_down')" class="sortable">ä¸‹è¡Œ% ${getFilterIcon('ps_down')} <span class="${getSortClass('ps_down')}">${getSortIcon('ps_down')}</span></th>
                        <th onclick="setSort('ps_up')" class="sortable">ä¸Šè¡Œ% ${getFilterIcon('ps_up')} <span class="${getSortClass('ps_up')}">${getSortIcon('ps_up')}</span></th>
                    </tr>
                </thead>
                <tbody>
            `;

            if(filteredData.length === 0) {
                html += `<tr><td colspan="16" style="padding:30px;text-align:center;color:#999;">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</td></tr>`;
            } else {
                filteredData.forEach(item => {
                    const fmtPct = (v) => {
                        if(v==='-') return '<span class="data-empty">-</span>';
                        const val = parseFloat(v);
                        const color = val >= 0 ? '#d32f2f' : '#2e7d32';
                        const weight = (val > 30) ? '800' : 'bold';
                        return `<span style="color:${color}; font-weight:${weight}">${v}%</span>`;
                    };

                    let tagsHtml = '';
                    if(item.tags) tagsHtml = item.tags.split(' ').map(t => t.trim()).filter(t=>t).map(t => `<span class="tag-badge">${t}</span>`).join('');

                    const lastDateRaw = (item.logs && item.logs.length > 0) ? item.logs[0].date : '';
                    let updateHtml = '<span class="data-empty" style="font-size:11px;">-</span>';
                    if(lastDateRaw) {
                        const parts = lastDateRaw.split(' ');
                        if(parts.length >= 2) {
                            updateHtml = `<span style="font-size:11px; color:#666; display:block; line-height:1.2;">${parts[0]}<br><span style="color:#999; font-size:10px;">${parts[1].slice(0,5)}</span></span>`;
                        } else {
                            updateHtml = `<span style="font-size:11px; color:#666;">${lastDateRaw}</span>`;
                        }
                    }

                    const rowId = 'row-' + item.code.replace(/\./g, '-');
                    const isChecked = selectedCodes.has(item.code) ? 'checked' : '';
                    const rowClass = isChecked ? 'row-selected' : '';

                    html += `
                        <tr id="${rowId}" class="${rowClass}">
                            <td style="font-weight:600; color:#343a40;">${item.name}</td>
                            <td class="${styleCode}" style="color:#868e96; font-size:12px;">${item.code}</td>
                            <td class="${styleTags}" style="text-align:left;">${tagsHtml}</td>
                            <td style="font-weight:bold; color:${parseFloat(item.chg)>=0 ? '#e03131':'#099268'}">${item.chg}%</td>
                            <td style="font-family:monospace; font-size:13px;">${item.cap ? item.cap.toFixed(2) : '-'}</td>
                            <td>${item.profit || '<span class="data-empty">-</span>'}</td>
                            <td style="font-size:12px;">${item.lowPE||'-'}~${item.highPE||'-'}</td>
                            <td>${fmtPct(item.peRes.down)}</td>
                            <td>${fmtPct(item.peRes.up)}</td>
                            <td>${item.revenue || '<span class="data-empty">-</span>'}</td>
                            <td style="font-size:12px;">${item.lowPS||'-'}~${item.highPS||'-'}</td>
                            <td>${fmtPct(item.psRes.down)}</td>
                            <td>${fmtPct(item.psRes.up)}</td>
                            <td class="${styleUpdate}">${updateHtml}</td>
                            <td style="white-space:nowrap;" class="${styleAction}">
                                <button class="btn-log" onclick="showLogs('${item.code}')" title="æ—¥å¿—">ğŸ“</button>
                                <button class="btn-edit" onclick="editStock('${item.code}')" title="ä¿®æ”¹">âœï¸</button>
                                <button class="btn-delete" onclick="openDeleteModal('${item.code}')" title="åˆ é™¤">âœ•</button>
                            </td>
                            <td class="td-select" onclick="toggleSelectRow('${item.code}')">
                                <input type="checkbox" class="row-checkbox" ${isChecked} onclick="event.stopPropagation(); toggleSelectRow('${item.code}')">
                            </td>
                        </tr>
                    `;
                });
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function toggleSelectRow(code) {
            if (selectedCodes.has(code)) {
                selectedCodes.delete(code);
            } else {
                selectedCodes.add(code);
            }
            updateTable();
        }

        function toggleSelectAll() {
            if (currentVisibleStocks.length === 0) return;
            const allSelected = currentVisibleStocks.every(item => selectedCodes.has(item.code));
            if (allSelected) currentVisibleStocks.forEach(item => selectedCodes.delete(item.code));
            else currentVisibleStocks.forEach(item => selectedCodes.add(item.code));
            updateTable();
        }

        function clearAllFilters() {
            columnFilters = {}; 
            document.getElementById('findInput').value = ''; 
            document.getElementById('findTags').value = '';
            if (onlySelectedMode) toggleShowSelected(); 
            updateTable();
        }

        function toggleShowSelected() {
            onlySelectedMode = !onlySelectedMode;
            const btn = document.getElementById('btn-compare');
            if (onlySelectedMode) { btn.classList.add('active'); btn.innerText = "ğŸ”™ æ˜¾ç¤ºå…¨éƒ¨"; }
            else { btn.classList.remove('active'); updateCompareBtn(); }
            updateTable();
        }
        function updateCompareBtn() { if (!onlySelectedMode) document.getElementById('btn-compare').innerText = `ğŸ“Š åªçœ‹é€‰ä¸­ (${selectedCodes.size})`; }

        function toggleColumn(colType) {
            if(colType === 'code') viewSettings.showCode = !viewSettings.showCode;
            if(colType === 'tags') viewSettings.showTags = !viewSettings.showTags;
            if(colType === 'update') viewSettings.showUpdate = !viewSettings.showUpdate;
            if(colType === 'action') viewSettings.showAction = !viewSettings.showAction;
            localStorage.setItem('viewSettings', JSON.stringify(viewSettings));
            updateViewButtons(); updateTable();
        }
        function updateViewButtons() {
            const btnCode = document.getElementById('btn-toggle-code');
            const btnTags = document.getElementById('btn-toggle-tags');
            const btnUpdate = document.getElementById('btn-toggle-update');
            const btnAction = document.getElementById('btn-toggle-action');
            
            if(viewSettings.showCode) btnCode.classList.add('active'); else btnCode.classList.remove('active');
            if(viewSettings.showTags) btnTags.classList.add('active'); else btnTags.classList.remove('active');
            if(viewSettings.showUpdate) btnUpdate.classList.add('active'); else btnUpdate.classList.remove('active');
            if(viewSettings.showAction) btnAction.classList.add('active'); else btnAction.classList.remove('active');
        }

        function openFilterMenu(colKey, event) {
            const menu = document.getElementById('filter-menu');
            const input = document.getElementById('filter-val');
            const op = document.getElementById('filter-op');
            const numRow = document.getElementById('filter-row-numeric');
            const textRow = document.getElementById('filter-row-text');
            const title = document.getElementById('filter-title');
            const isText = colKey === 'tags';
            numRow.style.display = isText ? 'none' : 'flex';
            textRow.style.display = isText ? 'flex' : 'none';
            title.innerText = isText ? "ç­›é€‰åŒ…å«å†…å®¹" : "æ•°å€¼ç­›é€‰";
            const rect = event.target.getBoundingClientRect();
            menu.style.top = (window.scrollY + rect.bottom + 5) + 'px';
            menu.style.left = Math.min(window.innerWidth - 230, (window.scrollX + rect.left - 100)) + 'px';
            menu.style.display = 'block';
            document.getElementById('filter-col-key').value = colKey;
            const existing = columnFilters[colKey];
            if (isText) {
                document.getElementById('filter-text-val').value = existing ? existing.val : "";
                document.getElementById('filter-text-val').focus();
            } else {
                if (existing) { op.value = existing.op; input.value = existing.val; } else { op.value = ">"; input.value = ""; }
                input.focus();
            }
            setTimeout(() => { document.addEventListener('click', closeFilterMenuOutside); }, 0);
        }
        function closeFilterMenuOutside(e) { const menu = document.getElementById('filter-menu'); if (!menu.contains(e.target)) { menu.style.display = 'none'; document.removeEventListener('click', closeFilterMenuOutside); } }
        function confirmFilter() {
            const colKey = document.getElementById('filter-col-key').value;
            const isText = colKey === 'tags';
            if (isText) {
                const val = document.getElementById('filter-text-val').value.trim();
                if (val === "") delete columnFilters[colKey]; else columnFilters[colKey] = { type: 'text', val: val };
            } else {
                const op = document.getElementById('filter-op').value;
                const valStr = document.getElementById('filter-val').value;
                if (valStr === "") delete columnFilters[colKey]; else columnFilters[colKey] = { type: 'num', op: op, val: parseFloat(valStr) };
            }
            document.getElementById('filter-menu').style.display = 'none'; document.removeEventListener('click', closeFilterMenuOutside); updateTable();
        }
        function clearCurrentFilter() { const colKey = document.getElementById('filter-col-key').value; delete columnFilters[colKey]; document.getElementById('filter-menu').style.display = 'none'; document.removeEventListener('click', closeFilterMenuOutside); updateTable(); }
        function getColName(key) { if(key=='pe_up') return 'PEä¸Šè¡Œ'; if(key=='pe_down') return 'PEä¸‹è¡Œ'; if(key=='ps_up') return 'PSä¸Šè¡Œ'; if(key=='ps_down') return 'PSä¸‹è¡Œ'; return key; }

        function saveStock() {
            const code = document.getElementById('inCode').value.trim();
            const name = document.getElementById('inName').value.trim();
            const note = document.getElementById('inNote').value.trim();
            const tags = document.getElementById('inTags').value.trim();
            const p = parseFloat(document.getElementById('inProfit').value)||0;
            const lpe = parseFloat(document.getElementById('inLowPE').value)||0;
            const hpe = parseFloat(document.getElementById('inHighPE').value)||0;
            const rev = parseFloat(document.getElementById('inRevenue').value)||0;
            const lps = parseFloat(document.getElementById('inLowPS').value)||0;
            const hps = parseFloat(document.getElementById('inHighPS').value)||0;

            if (!code || !name) { alert("è¯·å…ˆæœç´¢å¹¶åŒ¹é…è‚¡ç¥¨ä»£ç ï¼"); return; }
            const now = new Date().toLocaleString('zh-CN', { hour12: false });
            let changes = [];
            let newLog = null;
            const stockData = { code, name, tags, profit: p, lowPE: lpe, highPE: hpe, revenue: rev, lowPS: lps, highPS: hps, logs: [] };
            
            const idx = stocks.findIndex(s => s.code === code);
            if (idx >= 0) {
                const old = stocks[idx];
                stockData.logs = old.logs || [];
                
                if (old.profit !== p) changes.push(`å‡€åˆ©:${old.profit}â†’${p}`);
                if (old.lowPE !== lpe) changes.push(`PEä¸‹:${old.lowPE}â†’${lpe}`);
                if (old.highPE !== hpe) changes.push(`PEä¸Š:${old.highPE}â†’${hpe}`);
                if (old.revenue !== rev) changes.push(`è¥æ”¶:${old.revenue}â†’${rev}`);
                if (old.lowPS !== lps) changes.push(`PSä¸‹:${old.lowPS}â†’${lps}`);
                if (old.highPS !== hps) changes.push(`PSä¸Š:${old.highPS}â†’${hps}`);
                if ((old.tags||"") !== tags) changes.push(`å±æ€§:${old.tags||""}â†’${tags}`);

                if (changes.length > 0 || note) {
                    newLog = { 
                        date: now, 
                        content: changes.length > 0 ? changes.join('; ') : "æ·»åŠ å¤‡æ³¨", 
                        note: note 
                    };
                    stockData.logs.unshift(newLog);
                }
                stocks[idx] = stockData;
            } else {
                newLog = { date: now, content: "é¦–æ¬¡åˆ›å»º", note: note || "åˆå§‹åŒ–" };
                stockData.logs.push(newLog);
                stocks.push(stockData);
            }
            saveStorage();
            clearInput();
            updateTable();
        }

        function showLogs(c) { 
            const s = stocks.find(i=>i.code===c); 
            if(!s) return; 
            document.getElementById('modal-title').innerText = `${s.name} æ—¥å¿—`; 
            document.getElementById('modal-body').innerHTML = s.logs?.map(l => `
                <div class="log-entry">
                    <div class="log-time">${l.date}</div>
                    <div class="log-change">${l.content}</div>
                    ${l.note ? `<span class="log-note">${l.note}</span>` : ''}
                </div>
            `).join('') || '<div style="text-align:center;padding:20px;color:#999">æš‚æ— æ—¥å¿—è®°å½•</div>'; 
            document.getElementById('log-modal').style.display = 'flex'; 
        }
        
        function closeLogModal() { document.getElementById('log-modal').style.display='none'; }

        window.openDeleteModal = function(c) { pendingDeleteCode = c; document.getElementById('delete-msg').innerText=`ç¡®è®¤ä¸å†è·Ÿè¸ª ${c}?`; document.getElementById('delete-modal').style.display='flex'; };
        window.confirmDeleteAction = function() { if(pendingDeleteCode) { stocks=stocks.filter(s=>s.code!==pendingDeleteCode); selectedCodes.delete(pendingDeleteCode); saveStorage(); updateTable(); } closeDeleteModal(); };
        window.closeDeleteModal = function() { document.getElementById('delete-modal').style.display='none'; };
        
        function searchStockCode() { const name = document.getElementById('inName').value.trim(); if(!name) return; const btn = document.querySelector('.btn-search'); btn.innerText='...'; const sc = document.createElement('script'); window.handleSearch = function(d) { btn.innerText='ğŸ”'; if(d?.QuotationCodeTable?.Data?.length) { const r = d.QuotationCodeTable.Data[0]; let suf = r.MarketType=="1"?".SH":(r.MarketType=="2"?".SZ":(r.Code.length===5?".HK":"")); if(!suf && r.Code.length===6) suf = r.Code.startsWith('6')?".SH":".SZ"; document.getElementById('inCode').value = r.Code+suf; document.getElementById('inName').value = r.Name; } else { alert("æœªæ‰¾åˆ°"); } sc.remove(); }; sc.src = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(name)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=handleSearch`; document.body.appendChild(sc); }
        function toggleInputPanel() { const c=document.getElementById('input-container'); isPanelOpen=!isPanelOpen; c.style.display=isPanelOpen?'block':'none'; document.getElementById('toggle-btn').innerText=isPanelOpen?'ğŸ”¼ æ”¶èµ·':'â• å½•å…¥/ç®¡ç† (å±•å¼€)'; }
        function clearInput() { document.querySelectorAll('#input-panel input').forEach(i=>i.value=''); document.getElementById('editCode').value=''; document.getElementById('btn-save-text').innerText="ğŸ’¾ ä¿å­˜"; }
        function editStock(c) { toggleInputPanel(); isPanelOpen=true; document.getElementById('input-container').style.display='block'; const s=stocks.find(i=>i.code===c); if(!s)return; document.getElementById('inName').value=s.name; document.getElementById('inCode').value=s.code; document.getElementById('inTags').value=s.tags||''; document.getElementById('inProfit').value=s.profit||''; document.getElementById('inLowPE').value=s.lowPE||''; document.getElementById('inHighPE').value=s.highPE||''; document.getElementById('inRevenue').value=s.revenue||''; document.getElementById('inLowPS').value=s.lowPS||''; document.getElementById('inHighPS').value=s.highPS||''; document.getElementById('btn-save-text').innerText="ğŸ’¾ ç¡®è®¤ä¿®æ”¹"; }
        function startRealtime() { if(!intervalId) { updateTable(); intervalId=setInterval(updateTable, 5000); document.getElementById('status-msg').innerText="â— å®æ—¶ä¸­"; } }
        function stopRealtime() { clearInterval(intervalId); intervalId=null; document.getElementById('status-msg').innerText="â¸ æš‚åœ"; }
        function setSort(k) { if(sortState.key===k) sortState.dir=sortState.dir==='desc'?'asc':'desc'; else {sortState.key=k; sortState.dir='desc';} updateTable(); }
        function getSortIcon(k) { return sortState.key!==k?'â‡…':(sortState.dir==='desc'?'â¬‡':'â¬†'); }
        function getSortClass(k) { return sortState.key===k?'sort-icon sort-active':'sort-icon'; }
        function saveStorage() { localStorage.setItem('valuationStocks', JSON.stringify(stocks)); }
        
        window.onclick = function(e) { if(e.target.className==='modal') e.target.style.display='none'; }

        updateTable();
    </script>
</body>
</html>
