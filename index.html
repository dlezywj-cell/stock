<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å®æ—¶è¡¨æ ¼</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f9f9f9; }
        
        /* è¡¨æ ¼æ ·å¼ */
        table { border-collapse: collapse; width: 100%; margin-top: 10px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
        th { background-color: #f2f2f2; color: #333; }
        td.hide, th.hide { display: none; }
        td.stock-name { white-space: nowrap; font-weight: 600; }
        
        /* æŒ‰é’®å’Œæ§ä»¶åŒºåŸŸ */
        #controls { margin-bottom: 20px; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        button { cursor: pointer; padding: 6px 12px; margin-right: 5px; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        
        /* æ–°å¢è‚¡ç¥¨åŒºåŸŸæ ·å¼ */
        #add-panel { margin-bottom: 20px; padding: 15px; background: #eef2f7; border: 1px solid #cbd5e0; border-radius: 5px; }
        .input-group { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .input-wrapper { position: relative; display: flex; flex-direction: column; }
        .input-wrapper label { font-size: 12px; margin-bottom: 4px; color: #555; }
        input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* æœç´¢å»ºè®®ä¸‹æ‹‰æ¡† */
        #search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto;
            z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .search-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; display: flex; justify-content: space-between; }
        .search-item:hover { background-color: #f0f8ff; }
        .search-item .code { color: #888; font-size: 12px; }
        .search-item .market { background: #eee; padding: 1px 4px; border-radius: 3px; font-size: 11px; margin-left: 5px; }

        /* é¢„è§ˆä¿¡æ¯ */
        #preview-info { font-size: 12px; color: #007bff; margin-top: 5px; height: 1.2em; }
        .red { color: #ff3333; }
        .green { color: #00aa00; }
    </style>
</head>
<body>
    <h2>ğŸš€ æ™ºèƒ½è‚¡ç¥¨å®æ—¶ç›‘æ§</h2>
    
    <!-- æ–°å¢è‚¡ç¥¨é¢æ¿ -->
    <div id="add-panel">
        <h3 style="margin-top:0; font-size: 16px;">â• æ·»åŠ æ–°è‚¡ç¥¨ (æ”¯æŒæ¨¡ç³Šæœç´¢)</h3>
        <div class="input-group">
            <div class="input-wrapper" style="width: 250px;">
                <label>è‚¡ç¥¨åç§°/ä»£ç  (å¦‚: å°ç§¯ç”µ / baba)</label>
                <input type="text" id="stock-search" placeholder="è¾“å…¥åç§°æœç´¢..." autocomplete="off">
                <div id="search-results"></div>
            </div>
            
            <div class="input-wrapper" style="width: 100px;">
                <label>ä¸‹é™å¸‚å€¼(äº¿)</label>
                <input type="number" id="new-low" placeholder="ä¸‹é™">
            </div>
            
            <div class="input-wrapper" style="width: 100px;">
                <label>ä¸Šé™å¸‚å€¼(äº¿)</label>
                <input type="number" id="new-up" placeholder="ä¸Šé™">
            </div>
            
            <button onclick="confirmAddStock()" style="height: 30px; align-self: flex-end;">æ·»åŠ è‡³åˆ—è¡¨</button>
        </div>
        <div id="preview-info"></div>
    </div>

    <!-- ç°æœ‰æ§åˆ¶åŒº -->
    <div id="controls">
        <button onclick="startRealtime()">â–¶ å¼€å§‹æ›´æ–°</button>
        <button class="secondary" onclick="stopRealtime()">â¹ åœæ­¢</button>
        <button class="secondary" onclick="toggleCodeColumn()">æ˜¾ç¤º/éšè—ä»£ç </button>
        <button class="secondary" onclick="filterStocks()">ç­›é€‰ (æ½œåŠ›è‚¡)</button>
        <button class="secondary" onclick="sortByChange()">æŒ‰æ¶¨è·Œæ’åº</button>
    </div>

    <div id="result">è¡¨æ ¼åˆå§‹åŒ–ä¸­...</div>

    <script>
        let intervalId = null;
        let showCode = true;
        let isFiltered = false;
        let sortByChangePercent = false;

        // åˆå§‹åˆ—è¡¨ (ç¤ºä¾‹)
        const stocks = [
          { code: "9896.HK", name: "ååˆ›ä¼˜å“", lowLimit: 460, upLimit: 920 },
          { code: "BABA.N", name: "é˜¿é‡Œå·´å·´", lowLimit: 1500, upLimit: 3000 }, // æµ‹è¯•ç¾è‚¡
          { code: "600519.SH", name: "è´µå·èŒ…å°", lowLimit: 17860, upLimit: 20680 }
        ];

        // 1. æ ¸å¿ƒ: Secid ç”Ÿæˆé€»è¾‘ (åŒ…å«ç¾è‚¡åŒºåˆ†)
        function getSecid(stockCode) {
            let prefix, scode;
            // Aè‚¡
            if (stockCode.endsWith('.SH')) { prefix = '1'; scode = stockCode.replace('.SH', ''); }
            else if (stockCode.endsWith('.SZ')) { prefix = '0'; scode = stockCode.replace('.SZ', ''); }
            else if (stockCode.endsWith('.BJ')) { prefix = '0'; scode = stockCode.replace('.BJ', ''); }
            // æ¸¯è‚¡
            else if (stockCode.endsWith('.HK')) { prefix = '116'; scode = stockCode.replace('.HK', '').padStart(5, '0'); }
            // ç¾è‚¡ (æ ¸å¿ƒåŒºåˆ†é€»è¾‘)
            else if (stockCode.endsWith('.N')) { prefix = '106'; scode = stockCode.replace('.N', ''); } // çº½äº¤æ‰€
            else if (stockCode.endsWith('.O')) { prefix = '105'; scode = stockCode.replace('.O', ''); } // çº³æ–¯è¾¾å…‹
            else if (stockCode.endsWith('.A')) { prefix = '107'; scode = stockCode.replace('.A', ''); } // ç¾äº¤æ‰€
            else { 
                // é»˜è®¤å…œåº•
                prefix = '105'; scode = stockCode; 
            }
            return `${prefix}.${scode}`;
        }

        // 2. æ•°æ®è·å– (ä¿æŒä¸å˜)
        async function fetchStockData(stockCode) {
            const secid = getSecid(stockCode);
            const url = `https://push2.eastmoney.com/api/qt/stock/get?secid=${secid}&fields=f43,f60,f116,f58`; 
            // f116=æ€»å¸‚å€¼, f58=åç§°(ç”¨äºæ ¡éªŒ)
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (!data || !data.data) return null;
                
                // æå–å¸‚å€¼ (è‡ªåŠ¨å¤„ç†ä¸åŒå¸‚åœºå•ä½)
                // ä¸œæ–¹è´¢å¯Œæ¥å£è¿”å›çš„ç¾è‚¡ f116 æ˜¯ç¾å…ƒåŸå€¼ï¼ŒAè‚¡æ˜¯äººæ°‘å¸åŸå€¼ã€‚è¿™é‡Œç»Ÿä¸€é™¤ä»¥ 1äº¿
                const currentMarketCap = parseFloat(data.data.f116) / 100000000; 
                
                let changePercent = 0;
                let currentPrice = 0;
                
                if (data.data.f43 && data.data.f60) {
                    currentPrice = parseFloat(data.data.f43) / (stockCode.includes('.HK') || stockCode.includes('.SH') || stockCode.includes('.SZ') ? 100 : 100); 
                    // æ³¨æ„ï¼šä¸œæ–¹è´¢å¯Œ Aè‚¡/æ¸¯è‚¡ ä»·æ ¼é€šå¸¸æ˜¯æ”¾å¤§100å€è¿”å›çš„ï¼Œç¾è‚¡é€šå¸¸ä¹Ÿæ˜¯ï¼Œä½†æœ‰æ—¶æœ‰å·®å¼‚ï¼Œè¿™é‡Œæš‚æŒ‰100å¤„ç†é€šç”¨æƒ…å†µ
                    // æ›´ä¸¥è°¨çš„åšæ³•æ˜¯çœ‹ f59 (å°æ•°ç‚¹ä½æ•°)ï¼Œä½†ç®€å•ç‰ˆå…ˆè¿™æ ·
                    currentPrice = parseFloat(data.data.f43) / Math.pow(10, data.data.f59 || 2);
                    
                    const yesterdayClose = parseFloat(data.data.f60) / Math.pow(10, data.data.f59 || 2);
                    changePercent = ((currentPrice - yesterdayClose) / yesterdayClose * 100).toFixed(2);
                }
                return { currentMarketCap, changePercent, currentPrice, realName: data.data.f58 };
            } catch (err) {
                console.error("Data Fetch Error:", err);
                return null;
            }
        }

        // 3. æœç´¢åŠŸèƒ½ (æ–°åŠŸèƒ½)
        const searchInput = document.getElementById('stock-search');
        const resultsBox = document.getElementById('search-results');
        let selectedStock = null; // æš‚å­˜ç”¨æˆ·é€‰ä¸­çš„è‚¡ç¥¨

        searchInput.addEventListener('input', debounce(async (e) => {
            const val = e.target.value.trim();
            if (val.length < 1) { resultsBox.style.display = 'none'; return; }
            
            // è°ƒç”¨ä¸œæ–¹è´¢å¯Œæœç´¢æ¥å£
            const url = `https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(val)}&type=14&token=D43BF722C8E33BD5D065963F9441232D&count=6`;
            
            try {
                const res = await fetch(url);
                const json = await res.json();
                if(json.QuotationCodeTable && json.QuotationCodeTable.Data) {
                    renderSearchResults(json.QuotationCodeTable.Data);
                }
            } catch(err) { console.error(err); }
        }, 300));

        function renderSearchResults(data) {
            resultsBox.innerHTML = '';
            if(!data || data.length === 0) { resultsBox.style.display = 'none'; return; }
            
            data.forEach(item => {
                // è¯†åˆ«å¸‚åœºå¹¶ç”Ÿæˆåç¼€
                const marketType = item.MarketType; // 1=SH, 2=SZ, 116=HK, 105=NASDAQ, 106=NYSE
                let suffix = '';
                let marketName = '';
                
                if(marketType == '1') { suffix = '.SH'; marketName = 'æ²ªA'; }
                else if(marketType == '2') { suffix = '.SZ'; marketName = 'æ·±A'; }
                else if(marketType == '116') { suffix = '.HK'; marketName = 'æ¸¯è‚¡'; }
                else if(marketType == '105') { suffix = '.O'; marketName = 'ç¾è‚¡(Nas)'; }
                else if(marketType == '106') { suffix = '.N'; marketName = 'ç¾è‚¡(NYSE)'; }
                else if(marketType == '107') { suffix = '.A'; marketName = 'ç¾è‚¡(Amex)'; }
                else { return; } // ä¸æ”¯æŒçš„å¸‚åœºè·³è¿‡

                const cleanCode = item.Code;
                const finalCode = cleanCode + suffix;
                
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `
                    <span>${item.Name} <span class="code">${cleanCode}</span></span>
                    <span class="market">${marketName}</span>
                `;
                div.onclick = () => selectSearchResult(finalCode, item.Name);
                resultsBox.appendChild(div);
            });
            resultsBox.style.display = 'block';
        }

        async function selectSearchResult(code, name) {
            searchInput.value = `${name} (${code})`;
            resultsBox.style.display = 'none';
            selectedStock = { code, name };
            
            // é€‰ä¸­åï¼Œç«‹å³è·å–ä¸€æ¬¡æ•°æ®ä»¥é¢„è§ˆå¸‚å€¼
            document.getElementById('preview-info').innerHTML = 'æ­£åœ¨è·å–å½“å‰æ•°æ®...';
            const data = await fetchStockData(code);
            if(data) {
                const currency = code.includes('.HK') ? 'æ¸¯å¸' : (code.includes('.SH')||code.includes('.SZ') ? 'äººæ°‘å¸' : 'ç¾å…ƒ');
                document.getElementById('preview-info').innerHTML = 
                    `å½“å‰å¸‚å€¼: <b>${data.currentMarketCap.toFixed(2)}</b> äº¿${currency} | ç°ä»·: ${data.currentPrice}`;
                // è‡ªåŠ¨å¡«å…¥å½“å‰å¸‚å€¼ä½œä¸ºå‚è€ƒ
                // document.getElementById('new-low').value = Math.floor(data.currentMarketCap * 0.8);
                // document.getElementById('new-up').value = Math.floor(data.currentMarketCap * 1.2);
            } else {
                document.getElementById('preview-info').innerHTML = 'è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç ';
            }
        }

        function confirmAddStock() {
            if(!selectedStock) { alert('è¯·å…ˆæœç´¢å¹¶é€‰æ‹©ä¸€æ”¯è‚¡ç¥¨'); return; }
            const low = parseFloat(document.getElementById('new-low').value);
            const up = parseFloat(document.getElementById('new-up').value);
            
            if(isNaN(low) || isNaN(up)) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¸‚å€¼ä¸Šä¸‹é™'); return; }

            // æ·»åŠ åˆ°åˆ—è¡¨
            stocks.push({
                code: selectedStock.code,
                name: selectedStock.name,
                lowLimit: low,
                upLimit: up
            });
            
            // æ¸…ç©ºè¾“å…¥
            searchInput.value = '';
            document.getElementById('new-low').value = '';
            document.getElementById('new-up').value = '';
            document.getElementById('preview-info').innerHTML = '';
            selectedStock = null;
            
            // åˆ·æ–°è¡¨æ ¼
            updateTable();
            alert('æ·»åŠ æˆåŠŸï¼');
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // 4. è¡¨æ ¼æ¸²æŸ“ (é€»è¾‘ä¿æŒå¤§ä½“ä¸å˜)
        async function updateTable() {
            const resultDiv = document.getElementById('result');
            // å¦‚æœæ­£åœ¨æ·»åŠ è‚¡ç¥¨ï¼Œä¸è¦æ¸…ç©ºæ•´ä¸ªå†…å®¹ï¼Œåªæ›´æ–°è¡¨æ ¼éƒ¨åˆ†ï¼ˆä¼˜åŒ–ä½“éªŒå¯é€‰ï¼Œè¿™é‡Œç®€å•é‡ç»˜ï¼‰
            
            const stockData = await Promise.all(stocks.map(async stock => {
                const marketData = await fetchStockData(stock.code);
                if (!marketData) return null;
                const { currentMarketCap, changePercent } = marketData;
                const upSpace = ((stock.upLimit - currentMarketCap) / currentMarketCap * 100).toFixed(2);
                const downSpace = ((stock.lowLimit / currentMarketCap - 1) * 100).toFixed(2);
                return { ...stock, currentMarketCap, upSpace, downSpace, changePercent };
            }));

            let validData = stockData.filter(item => item !== null);

            // ç­›é€‰é€»è¾‘
            if (isFiltered) {
                validData = validData.filter(stock => {
                    const downSpaceValue = parseFloat(stock.downSpace);
                    const upSpaceValue = parseFloat(stock.upSpace);
                    // é€»è¾‘ï¼šä¸‹è·Œç©ºé—´å°(å¤§äº-20%) ä¸” ç›ˆäºæ¯”é«˜(å‘ä¸Šç©ºé—´æ˜¯å‘ä¸‹ç©ºé—´çš„2å€ä»¥ä¸Š)
                    // æ³¨æ„ï¼šdownSpaceé€šå¸¸æ˜¯è´Ÿæ•°ï¼Œæ‰€ä»¥ç”¨ç»å¯¹å€¼æ¯”è¾ƒ
                    return downSpaceValue > -20 && upSpaceValue > Math.abs(downSpaceValue * 2);
                });
            }

            // æ’åºé€»è¾‘
            if (sortByChangePercent) {
                validData.sort((a, b) => parseFloat(b.changePercent) - parseFloat(a.changePercent));
            } else {
                // é»˜è®¤æŒ‰å‘ä¸Šç©ºé—´æ’åº
                validData.sort((a, b) => parseFloat(b.upSpace) - parseFloat(a.upSpace));
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="${showCode ? '' : 'hide'}">ä»£ç </th>
                            <th>åç§°</th>
                            <th>æ¶¨è·Œå¹…</th>
                            <th>å¸‚å€¼ (äº¿)</th>
                            <th>å‘ä¸Šç©ºé—´</th>
                            <th>å‘ä¸‹ç©ºé—´</th>
                        </tr>
                    </thead>
                    <tbody>`;

            validData.forEach(stock => {
                const chg = parseFloat(stock.changePercent);
                const color = chg > 0 ? '#ff3333' : (chg < 0 ? '#00aa00' : '#333');
                const weight = Math.abs(chg) > 3 ? 'bold' : 'normal';
                
                tableHTML += `
                    <tr>
                        <td class="${showCode ? '' : 'hide'}" style="color:#666; font-size:12px;">${stock.code}</td>
                        <td class="stock-name">${stock.name}</td>
                        <td style="color:${color}; font-weight:${weight};">${stock.changePercent}%</td>
                        <td>${stock.currentMarketCap.toFixed(2)}</td>
                        <td style="color:${parseFloat(stock.upSpace)>0?'#d20':'#333'}">${stock.upSpace}%</td>
                        <td style="color:#666">${stock.downSpace}%</td>
                    </tr>`;
            });
            tableHTML += '</tbody></table>';
            
            resultDiv.innerHTML = tableHTML;
        }

        function toggleCodeColumn() { showCode = !showCode; updateTable(); }
        function filterStocks() { isFiltered = !isFiltered; updateTable(); }
        function sortByChange() { sortByChangePercent = !sortByChangePercent; updateTable(); }
        function startRealtime() { if(!intervalId) { updateTable(); intervalId = setInterval(updateTable, 3000); } }
        function stopRealtime() { if(intervalId) { clearInterval(intervalId); intervalId = null; } }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢æ¡†
        document.addEventListener('click', (e) => {
            if (!document.getElementById('add-panel').contains(e.target)) {
                resultsBox.style.display = 'none';
            }
        });

        // å¯åŠ¨æ—¶åˆ·æ–°ä¸€æ¬¡
        updateTable();
    </script>
</body>
</html>
