<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡ç¥¨ä¼°å€¼ç³»ç»Ÿ (æ»šåŠ¨å®Œç¾ä¿®å¤ç‰ˆ)</title>
    <style>
        /* === å…¨å±€é‡ç½® === */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif; padding: 20px; max-width: 1700px; margin: 0 auto; background-color: #f4f6f9; font-size: 13px; color: #333; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        
        /* === ç§»åŠ¨ç«¯ä¸“å±å¯¼èˆª === */
        #mobile-nav { display: none; justify-content: space-between; align-items: center; background: #fff; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        #mobile-nav h3 { margin: 0; color: #2c3e50; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        #mobile-status { font-size: 11px; color: #007bff; font-family: monospace; }
        .btn-menu { background: #f8f9fa; border: 1px solid #ddd; color: #333; padding: 6px 12px; border-radius: 4px; font-size: 14px; }

        /* === é¡¶éƒ¨åŒºåŸŸ === */
        #top-area { flex-shrink: 0; display: flex; flex-direction: column; } /* ç¡®ä¿å­å…ƒç´ å‚ç›´æ’åˆ— */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .tool-group { display: flex; align-items: center; gap: 10px; }

        /* === è¿›åº¦æ¡ === */
        #progress-bar-container { flex-grow:1; margin: 0 15px; display:none; align-items:center; gap:10px; }
        #progress-bg { flex-grow:1; height:8px; background:#eee; border-radius:4px; overflow:hidden; }
        #progress-fill { height:100%; width:0%; background:linear-gradient(90deg, #007bff, #00c6ff); transition: width 0.2s; }
        #progress-text { font-size:11px; color:#666; font-family:monospace; white-space:nowrap; }

        /* === æ§åˆ¶æ  === */
        .control-bar { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; flex-shrink: 0; }
        .divider { border-left: 1px solid #eee; height: 20px; margin: 0 5px; }
        .spacer { flex-grow: 1; } 

        /* === å½•å…¥é¢æ¿ (æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ æ»šåŠ¨æ”¯æŒ) === */
        #input-container { 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            transition: all 0.3s ease; 
            margin-bottom: 15px; 
            display: none; 
            
            /* â˜…â˜…â˜… è¿™é‡Œçš„è®¾ç½®è®©é¢æ¿å†…å®¹è¿‡å¤šæ—¶å¯ä»¥æ»šåŠ¨ â˜…â˜…â˜… */
            max-height: 60vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„60% */
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch; /* iOSé¡ºæ»‘æ»šåŠ¨ */
            overscroll-behavior: contain; /* é˜²æ­¢æ»šåŠ¨ç©¿é€åˆ°åº•å±‚ */
        }
        
        #input-panel { padding: 20px; border-top: 3px solid #007bff; }
        .input-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .group-box { border: 1px solid #e9ecef; padding: 15px; border-radius: 6px; background: #f8f9fa; display: flex; gap: 10px; }
        
        label { font-size: 12px; color: #666; display: block; margin-bottom: 4px; font-weight: 500; }
        input { padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px; width: 100px; transition: border-color 0.2s; }
        input:focus { border-color: #007bff; outline: none; }
        input[readonly] { background-color: #e9ecef; color: #495057; cursor: not-allowed; }
        
        button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; transition: all 0.2s; font-size: 12px; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
        button:hover { opacity: 0.85; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .btn-search { background-color: #17a2b8; color: white; }
        .btn-add { background-color: #28a745; color: white; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-log { background-color: #6f42c1; color: white; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-cloud-pull { background-color: #6610f2; color: white; } 
        .btn-cloud-push { background-color: #fd7e14; color: white; }
        .btn-control { background-color: #6c757d; color: white; }
        .btn-toggle { background-color: #f8f9fa; border: 1px solid #ccc; color: #333; margin-right: 10px; }
        .btn-find { background-color: #fd7e14; color: white; }
        .btn-view { background-color: #e9ecef; color: #adb5bd; border: 1px solid transparent; }
        .btn-view.active { background-color: #007bff; color: white; border-color: #007bff; }
        .btn-compare { background-color: #6f42c1; color: white; }
        .btn-compare.active { background-color: #4a2c85; box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); }
        .btn-reset-all { background-color: #6c757d; color: white; }
        .btn-confirm-del { background-color: #dc3545; color: white; font-size: 14px; padding: 8px 25px; }
        .btn-cancel { background-color: #6c757d; color: white; font-size: 14px; padding: 8px 25px; }

        /* === è¡¨æ ¼åŒºåŸŸ === */
        #result { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e9ecef; flex-grow: 1; overflow: auto; position: relative; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; min-width: 1350px; }
        th, td { padding: 10px 12px; text-align: center; border-bottom: 1px solid #ebebeb; border-right: 1px solid #ebebeb; white-space: nowrap; }
        
        /* é”å®šåˆ—è¡¨å¤´ */
        th { background-color: #f1f3f5; color: #495057; font-weight: 700; user-select: none; position: sticky; z-index: 20; }
        thead tr:nth-child(1) th { top: 0; border-bottom: 1px solid #ccc; height: 22px; }
        thead tr:nth-child(2) th { top: 43px; box-shadow: 0 2px 2px rgba(0,0,0,0.05); }

        /* é”å®šåˆ—ï¼šç¬¬1åˆ—(è¶‹åŠ¿) & ç¬¬2åˆ—(åç§°) - PCé»˜è®¤æ ·å¼ */
        tbody td:nth-child(1) { position: sticky; left: 0; z-index: 15; background-color: #fff; border-right: 1px solid #eee; width: 30px; max-width: 30px; padding: 0 5px; }
        /* PCç«¯åç§°åˆ— */
        tbody td:nth-child(2) { 
            position: sticky; left: 41px; z-index: 15; 
            background-color: #fff; border-right: 2px solid #d1d1d1; 
            max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        
        /* è¡¨å¤´é”å®š */
        thead tr:nth-child(1) th:first-child { position: sticky; top: 0; z-index: 20; }
        thead tr:nth-child(2) th:nth-child(1) { position: sticky; left: 0; top: 43px; z-index: 30; border-right: 1px solid #eee; width: 30px; }
        thead tr:nth-child(2) th:nth-child(2) { 
            position: sticky; left: 41px; top: 43px; z-index: 30; 
            border-right: 2px solid #d1d1d1;
            max-width: 80px;
        }

        /* é˜´å½±åˆ†å‰²çº¿ */
        tbody td:nth-child(2), thead tr:nth-child(2) th:nth-child(2) {
            box-shadow: 4px 0 8px -4px rgba(0,0,0,0.15); 
            clip-path: inset(0px -15px 0px 0px);
        }

        /* éš”è¡Œå˜è‰²ä¿®å¤ */
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:nth-child(even) td:nth-child(1), 
        tbody tr:nth-child(even) td:nth-child(2) { background-color: #f8f9fa; }

        tbody tr:hover td { background-color: #e9ecef; }
        tbody tr:hover td:nth-child(1), 
        tbody tr:hover td:nth-child(2) { background-color: #e9ecef; }

        .row-selected td,
        .row-selected td:nth-child(1),
        .row-selected td:nth-child(2) { background-color: #e8f0fe !important; }

        .col-hidden { display: none !important; }
        .tag-badge { display: inline-block; background: #e7f5ff; color: #007bff; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin: 1px; border: 1px solid #d0ebff; }
        .th-basic { border-top: 3px solid #6c757d; }
        .th-pe { border-top: 3px solid #28a745; background-color: #f3fdf6; }
        .th-ps { border-top: 3px solid #fd7e14; background-color: #fff8f3; }
        
        .th-select, .td-select { width: 40px !important; padding: 0 !important; cursor: pointer; }
        .th-select { border-top: 3px solid #adb5bd; border-left: 2px solid #dee2e6 !important; background-color: #e9ecef; z-index: 25; }
        .td-select { border-left: 2px solid #dee2e6 !important; background-color: #f8f9fa; }
        
        .row-checkbox { cursor: pointer; accent-color: #007bff; width: 15px; height: 15px; margin: 0 auto; display: block; }
        .filter-icon { font-size: 12px; color: #adb5bd; cursor: pointer; padding: 2px 4px; }
        .filter-active { color: #dc3545 !important; font-weight: bold; background-color: #f8d7da; }
        .data-empty { color: #ccc; font-weight: normal; }
        #status-msg { font-size: 12px; color: #007bff; margin-right: 10px; font-family: monospace; }
        .sort-icon { font-size: 10px; margin-left: 4px; color: #adb5bd; }
        .sort-active { color: #007bff; }
        th.sortable:hover { background-color: #e2e6ea; cursor: pointer; color: #007bff; }

        /* å¼¹çª— */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); justify-content: center; align-items: center; }
        #delete-modal { z-index: 2200; } #sync-modal { z-index: 2100; } #log-modal { z-index: 2000; }
        #filter-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 6px; padding: 12px; z-index: 3000; min-width: 200px; }
        
        /* === å¼¹çª—å†…å®¹æ»šåŠ¨ä¿®å¤ === */
        .modal-content { 
            background-color: white; 
            padding: 25px; 
            border-radius: 12px; 
            width: 500px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); 
            position: relative; 
            animation: slideDown 0.2s ease-out; 
            
            /* â˜…â˜…â˜… å…³é”®ä¿®å¤ â˜…â˜…â˜… */
            max-height: 80vh; /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto; /* å†…å®¹æº¢å‡ºæ»šåŠ¨ */
            -webkit-overflow-scrolling: touch; 
            overscroll-behavior: contain;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; z-index: 10; } /* æé«˜å±‚çº§ */
        .log-entry { border-bottom: 1px solid #eee; padding: 12px 0; font-size: 13px; color: #444; }
        .log-time { color: #999; font-size: 12px; margin-bottom: 4px; }
        .log-note { display: block; margin-top: 6px; color: #555; background: #fff3cd; padding: 6px 10px; border-radius: 4px; border-left: 3px solid #ffc107; }
        .log-del-btn { cursor: pointer; color: #dc3545; opacity: 0.6; transition: all 0.2s; font-size: 14px; }
        .log-del-btn:hover { opacity: 1; transform: scale(1.1); }
        .sync-info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f1f1; }
        .sync-val.new { color: #28a745; } .sync-val.old { color: #dc3545; }

        /* â˜…â˜…â˜… ç§»åŠ¨ç«¯æ·±åº¦ä¼˜åŒ– â˜…â˜…â˜… */
        @media (max-width: 768px) {
            body { padding: 10px; }
            #mobile-nav { display: flex; }
            #top-area { display: none; }
            #top-area.show { display: block; animation: slideDown 0.2s ease-out; }
            .header-bar { flex-direction: column; gap: 10px; padding: 10px; }
            .tool-group { width: 100%; justify-content: space-between; }
            .tool-group button { flex: 1; justify-content: center; }
            .control-bar { flex-direction: column; align-items: stretch; gap: 8px; padding: 10px; }
            .control-bar > * { width: 100%; margin: 0; }
            .spacer, .divider { display: none; }
            .search-row { display: flex; gap: 5px; }
            .search-row input { flex: 1; width: auto !important; }
            .action-row { display: flex; gap: 5px; flex-wrap: wrap; }
            .action-row button { flex: 1; justify-content: center; }
            #input-panel { padding: 15px 10px; }
            .input-row { flex-direction: column; gap: 10px; margin-bottom: 10px; }
            .group-box { width: 100%; box-sizing: border-box; }
            input { width: 100% !important; box-sizing: border-box; }
            .modal-content { width: 90%; padding: 20px; max-height: 85vh; } /* æ‰‹æœºç«¯å¼¹çª—æ›´å……è£• */

            /* === è¡¨æ ¼ç´§å‡‘åŒ– === */
            th, td { padding: 8px 3px; font-size: 12px; } 

            /* 1. è¶‹åŠ¿åˆ— (Trend) æçª„ - 25px */
            tbody td:nth-child(1) { 
                width: 25px !important; 
                min-width: 25px !important; 
                max-width: 25px !important; 
                left: 0 !important;
                padding: 0 !important; 
                text-align: center; 
            }
            thead tr:nth-child(2) th:nth-child(1) { 
                width: 25px !important; 
                min-width: 25px !important; 
                max-width: 25px !important;
                left: 0 !important;
                padding: 0 !important;
            }

            /* 2. åç§°åˆ— (Name) æåº¦å‹ç¼© - 65px (çº¦5ä¸ªæ±‰å­—) */
            tbody td:nth-child(2) { 
                left: 25px !important; /* ç´§æŒ¨è¶‹åŠ¿åˆ— */
                width: 65px !important; 
                min-width: 65px !important; 
                max-width: 65px !important; 
                font-size: 11px;
                padding: 8px 2px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            thead tr:nth-child(2) th:nth-child(2) { 
                left: 25px !important;
                width: 65px !important;
                min-width: 65px !important;
                max-width: 65px !important;
                padding: 8px 2px !important;
                font-size: 11px;
            }
        }
        .search-row { display: flex; align-items: center; gap: 5px; }
        .action-row { display: flex; align-items: center; gap: 5px; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="mobile-nav">
        <h3>ğŸ“ˆ ä¼°å€¼ç³»ç»Ÿ <span id="mobile-status"></span></h3>
        <button class="btn-menu" onclick="toggleMobileMenu()" id="mobile-menu-btn">âš™ï¸ èœå•</button>
    </div>

    <div id="top-area">
        <div class="header-bar">
            <div class="tool-group">
                <button class="btn-cloud-pull" onclick="syncFromGithub()">â˜ï¸ æ‹‰å–æ•°æ®</button>
                <button class="btn-cloud-push" onclick="uploadToGithub()">ğŸš€ ä¿å­˜åˆ° GitHub</button>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div id="progress-bar-container">
                <div id="progress-bg"><div id="progress-fill"></div></div>
                <div id="progress-text">å‡†å¤‡ä¸­...</div>
            </div>
            <div class="tool-group">
                <span id="status-msg"></span>
                <button class="btn-refresh-trend" onclick="forceRefreshTrends()" title="æ¸…ç©ºç¼“å­˜å¹¶é‡æ–°æ‹‰å–æ‰€æœ‰è¶‹åŠ¿æ•°æ®" style="padding:6px 12px; border-radius:4px; background:#17a2b8; color:white; border:none; cursor:pointer;">ğŸ”„ åˆ·æ–°è¶‹åŠ¿</button>
                <div class="divider"></div>
                <button class="btn-control" onclick="startRealtime()">â–¶ å¼€å¯</button>
                <button class="btn-control" onclick="stopRealtime()">â¹ æš‚åœ</button>
            </div>
        </div>

        <div class="control-bar">
            <button class="btn-toggle" onclick="toggleInputPanel()" id="toggle-btn">â• å½•å…¥/ç®¡ç†</button>
            <div class="divider"></div>
            <div class="search-row">
                <span style="font-size:12px; color:#666;" class="desktop-only">ğŸ”:</span>
                <input type="text" id="findInput" placeholder="ä»£ç /åç§°" style="width: 100px;" onkeydown="if(event.keyCode==13) updateTable()">
                <input type="text" id="findTags" placeholder="å±æ€§/èµ›é“" style="width: 100px;" onkeydown="if(event.keyCode==13) updateTable()">
                <button class="btn-find" onclick="updateTable()">Go</button>
            </div>
            <div class="spacer"></div>
            <div class="action-row">
                <span class="control-label desktop-only" style="margin-right:5px;font-size:12px;color:#666;">ğŸ‘ï¸:</span>
                <button class="btn-view active" id="btn-toggle-code" onclick="toggleColumn('code')">ä»£ç </button>
                <button class="btn-view active" id="btn-toggle-tags" onclick="toggleColumn('tags')">å±æ€§</button>
                <button class="btn-view" id="btn-toggle-cap" onclick="toggleColumn('cap')">å¸‚å€¼</button>
                <button class="btn-view active" id="btn-toggle-update" onclick="toggleColumn('update')">æ›´æ–°</button>
                <button class="btn-view active" id="btn-toggle-action" onclick="toggleColumn('action')">æ“ä½œ</button>
            </div>
            <div class="divider"></div>
            <div class="action-row">
                <button class="btn-reset-all" onclick="clearAllFilters()">ğŸŒªï¸ é‡ç½®</button>
                <button class="btn-compare" id="btn-compare" onclick="toggleShowSelected()">ğŸ“Š é€‰ä¸­ (0)</button>
            </div>
        </div>

        <div id="input-container">
            <div id="input-panel">
                <input type="hidden" id="editCode" value="">
                <div class="input-row">
                    <div class="group-box" style="background: #fff; border-color: #ddd; flex: 1.2;">
                        <div style="display:flex; gap:5px; width:100%; align-items:center;">
                            <label style="width:40px">åç§°</label>
                            <input type="text" id="inName" placeholder="å¦‚: è…¾è®¯" style="flex:1">
                            <button class="btn-search" onclick="searchStockCode()">ğŸ”</button>
                        </div>
                        <div style="display:flex; gap:5px; width:100%; align-items:center; margin-top:5px;">
                            <label style="width:40px">ä»£ç </label>
                            <input type="text" id="inCode" readonly placeholder="è‡ªåŠ¨" style="flex:1; background:#f0f0f0">
                        </div>
                    </div>
                    <div class="group-box" style="background: #fff; border-color: #ddd; flex: 2; flex-direction: column;">
                        <div style="display:flex; gap:5px; width:100%; align-items:center;">
                            <label style="width:60px">å±æ€§/èµ›é“</label>
                            <input type="text" id="inTags" placeholder="ç©ºæ ¼åˆ†éš”" style="flex:1">
                        </div>
                        <div style="display:flex; gap:5px; width:100%; align-items:center;">
                            <label style="width:60px">å¤‡æ³¨(æ—¥å¿—)</label>
                            <input type="text" id="inNote" placeholder="è¾“å…¥æƒ³æ³•..." style="flex:1">
                        </div>
                    </div>
                </div>
                <div class="input-row">
                    <div class="group-box" style="border-left: 4px solid #28a745; flex:1;">
                        <div style="width:100%; margin-bottom:5px;"><span style="color:#28a745; font-weight:bold;">â‘  PE ä¼°å€¼ (å‡€åˆ©)</span></div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <div><label>å‡€åˆ©(äº¿)</label><input type="number" id="inProfit" step="0.1"></div>
                            <div><label>PEä¸‹é™</label><input type="number" id="inLowPE"></div>
                            <div><label>PEä¸Šé™</label><input type="number" id="inHighPE"></div>
                        </div>
                    </div>
                    <div class="group-box" style="border-left: 4px solid #fd7e14; flex:1;">
                        <div style="width:100%; margin-bottom:5px;"><span style="color:#fd7e14; font-weight:bold;">â‘¡ PS ä¼°å€¼ (è¥æ”¶)</span></div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <div><label>è¥æ”¶(äº¿)</label><input type="number" id="inRevenue" step="0.1"></div>
                            <div><label>PSä¸‹é™</label><input type="number" id="inLowPS" step="0.1"></div>
                            <div><label>PSä¸Šé™</label><input type="number" id="inHighPS" step="0.1"></div>
                        </div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn-add" onclick="saveStock()" id="btn-save-text" style="padding:8px 30px; font-size:14px;">ğŸ’¾ ä¿å­˜</button>
                    <button onclick="clearInput()" style="padding:8px 20px; margin-left:10px;">é‡ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result"></div>

    <div id="filter-menu"><h4 id="filter-title">ç­›é€‰</h4><div class="filter-row" id="filter-row-numeric"><select id="filter-op"><option value=">">></option><option value="<"><</option><option value=">=">â‰¥</option><option value="<=">â‰¤</option><option value="=">=</option></select><input type="number" id="filter-val" placeholder="æ•°å€¼"></div><div class="filter-row" id="filter-row-text" style="display:none;"><input type="text" id="filter-text-val" placeholder="å†…å®¹..."></div><div class="filter-actions"><button class="btn-cancel" onclick="clearCurrentFilter()">æ¸…ç©º</button><button class="btn-add" onclick="confirmFilter()">ç¡®å®š</button></div><input type="hidden" id="filter-col-key"></div>
    <div id="log-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeLogModal()">&times;</span><h3 id="modal-title" style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:15px;">æ—¥å¿—</h3><div id="modal-body"></div></div></div>
    <div id="delete-modal" class="modal"><div class="modal-content" style="text-align: center; padding-top: 30px;"><h3>âš ï¸ ç¡®è®¤åˆ é™¤ï¼Ÿ</h3><p id="delete-msg" style="color:#555; margin-bottom:30px;">...</p><div><button class="btn-confirm-del" onclick="confirmDeleteAction()">åˆ é™¤</button><button class="btn-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button></div></div></div>
    <div id="sync-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeSyncModal()">&times;</span><h3 style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:15px;">â˜ï¸ åŒæ­¥ç¡®è®¤</h3><div style="padding: 10px 0;"><div class="sync-info-row"><span class="sync-label">äº‘ç«¯:</span><span class="sync-val" id="sync-cloud-date">...</span></div><div class="sync-info-row"><span class="sync-label">æœ¬åœ°:</span><span class="sync-val" id="sync-local-date">...</span></div><div class="sync-info-row"><span class="sync-label">æ•°é‡:</span><span class="sync-val" id="sync-count">...</span></div></div><div style="text-align:right; margin-top:20px;"><button class="btn-cloud-pull" onclick="confirmSyncAction()" style="padding:8px 20px;">âœ… è¦†ç›–</button><button class="btn-cancel" onclick="closeSyncModal()" style="padding:8px 20px;">å–æ¶ˆ</button></div></div></div>

    <script>
        function getNowStr() { const d = new Date(); const pad = (n) => n.toString().padStart(2, '0'); return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
        function toggleMobileMenu(force) { const area = document.getElementById('top-area'), btn = document.getElementById('mobile-menu-btn'), isHidden = area.style.display === 'none' || getComputedStyle(area).display === 'none', show = force !== undefined ? force : isHidden; if (show) { area.style.display = 'block'; area.classList.add('show'); btn.innerText = 'ğŸ”¼ æ”¶èµ·'; } else { area.style.display = 'none'; area.classList.remove('show'); btn.innerText = 'âš™ï¸ èœå•'; } }
        if (window.innerWidth <= 768) document.getElementById('top-area').style.display = 'none';

        let stocks = JSON.parse(localStorage.getItem('valuationStocks')) || [];
        let viewSettings = { showCode: true, showTags: true, showUpdate: true, showAction: true, showCap: false, ...JSON.parse(localStorage.getItem('viewSettings')) };
        let intervalId = null, sortState = { key: 'pe_up', dir: 'desc' }, isPanelOpen = false, pendingDeleteCode = null, pendingLogIndex = null, pendingSyncData = null, cachedMarketData = {}, selectedCodes = new Set(), columnFilters = {}, onlySelectedMode = false;
        
        let historyCache = {}; 
        let fetchQueue = [];
        let activeRequests = 0;
        const MAX_CONCURRENT = 8; 
        let fetchingSet = new Set();
        
        function updateProgress(done, total) {
            const bar = document.getElementById('progress-bar-container');
            if (!bar) return;
            if (done >= total && total > 0) {
                setTimeout(() => bar.style.display = 'none', 1000);
            } else if (total > 0) {
                bar.style.display = 'flex';
                const pct = Math.round((done / total) * 100) + '%';
                document.getElementById('progress-fill').style.width = pct;
                document.getElementById('progress-text').innerText = `ğŸ“ˆ ${done}/${total}`;
            }
        }

        updateViewButtons();
        const GITHUB_CONFIG = { username: "dlezywj-cell", repo: "stock", path: "data.jason", branch: "main" };
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

        async function uploadToGithub() {
            let token = localStorage.getItem("github_token"); if (!token) { token = prompt("ğŸ”‘ è¯·è¾“å…¥ GitHub Token:"); if (!token) return; localStorage.setItem("github_token", token); }
            const btn = document.querySelector('.btn-cloud-push'); const origin = btn.innerText; btn.innerText = "â³..."; btn.disabled = true;
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
                const get = await fetch(url, { headers: { "Authorization": `token ${token}` }, cache: "no-store" });
                let sha = null; if (get.ok) sha = (await get.json()).sha;
                const put = await fetch(url, { method: "PUT", headers: { "Authorization": `token ${token}` }, body: JSON.stringify({ message: "Update", content: utf8_to_b64(JSON.stringify(stocks,null,2)), sha }) });
                if (put.ok) alert("âœ… æˆåŠŸ"); else throw new Error((await put.json()).message);
            } catch (e) { if(e.message.includes("401")){alert("Tokenå¤±æ•ˆ");localStorage.removeItem("github_token");}else alert("âŒ "+e.message); } finally { btn.innerText = origin; btn.disabled = false; }
        }

        async function syncFromGithub() {
            let token = localStorage.getItem("github_token");
            const btn = document.querySelector('.btn-cloud-pull'); const origin = btn.innerText; btn.innerText = "âŒ›..."; btn.disabled = true;
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
                const headers = { "Accept": "application/vnd.github.v3+json" }; if(token) headers["Authorization"] = `token ${token}`;
                let res = await fetch(url, { headers, cache: "no-store" }), data;
                if (res.ok) data = JSON.parse(b64_to_utf8((await res.json()).content));
                else { const raw = await fetch(`https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.path}?t=${Date.now()}`); if(!raw.ok) throw new Error("æ— æ³•è®¿é—®"); data = await raw.json(); }
                if (Array.isArray(data)) {
                    pendingSyncData = data;
                    const cDate = data[0]?.logs?.[0]?.date || "æ— ", lDate = stocks[0]?.logs?.[0]?.date || "æ— ";
                    document.getElementById('sync-cloud-date').innerText = cDate; document.getElementById('sync-local-date').innerText = lDate; document.getElementById('sync-count').innerText = `${data.length} vs ${stocks.length}`;
                    const el = document.getElementById('sync-cloud-date');
                    if(cDate>lDate){el.className="sync-val new";el.innerText+=" (æ–°)";} else if(cDate<lDate){el.className="sync-val old";el.innerText+=" (æ—§)";} else el.className="sync-val";
                    document.getElementById('sync-modal').style.display = 'flex';
                }
            } catch (e) { alert("âŒ "+e.message); } finally { btn.innerText = origin; btn.disabled = false; }
        }
        function confirmSyncAction() { if(pendingSyncData){stocks=pendingSyncData;saveStorage();updateTable();closeSyncModal();} }
        function closeSyncModal() { document.getElementById('sync-modal').style.display='none';pendingSyncData=null; }

        function getSecid(c) { return (c.endsWith('.SH')?`1.${c.slice(0,-3)}`:c.endsWith('.SZ')?`0.${c.slice(0,-3)}`:c.endsWith('.HK')?`116.${c.slice(0,-3)}`:`105.${c}`); }
        
        function toYahooSymbol(emCode) {
            const parts = emCode.split('.');
            const mkt = parts[0], code = parts[1];
            if (mkt === '0') return code + '.SZ';
            if (mkt === '1') return code + '.SS';
            if (mkt === '116') { let n = parseInt(code,10); return n.toString().padStart(4,'0') + '.HK'; }
            if (mkt === '105') return code;
            return code;
        }

        async function runFetcher() {
            while (fetchQueue.length > 0 && activeRequests < MAX_CONCURRENT) {
                const { secid, code, resolve } = fetchQueue.shift();
                activeRequests++;
                fetchHistoryImpl(secid, code).then(res => { resolve(res); }).finally(() => {
                    activeRequests--;
                    updateProgress(Object.keys(historyCache).length, stocks.length);
                    runFetcher();
                });
            }
            if (fetchQueue.length === 0 && activeRequests === 0) { updateTable(true); }
        }

        function queueFetchHistory(secid, code) {
            return new Promise((resolve) => {
                if (historyCache[code] !== undefined) { resolve(historyCache[code]); return; }
                if (fetchingSet.has(code)) return;
                fetchingSet.add(code);
                fetchQueue.push({ secid, code, resolve });
                runFetcher();
            });
        }

        async function fetchHistoryImpl(secid, code) {
            const yahooSymbol = toYahooSymbol(secid);
            const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?range=1mo&interval=1d`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
            try {
                const res = await fetch(proxyUrl);
                if (!res.ok) { historyCache[code] = null; fetchingSet.delete(code); return null; }
                const json = await res.json();
                const result = json?.chart?.result?.[0];
                if (result?.indicators?.quote?.[0]?.close) {
                    const closes = result.indicators.quote[0].close.filter(p => p !== null);
                    historyCache[code] = closes;
                    fetchingSet.delete(code);
                    return closes;
                }
            } catch(e) { }
            historyCache[code] = null; fetchingSet.delete(code); return null;
        }

        function getTrendIcon(history, currentPrice, code) {
            if (!history || history.length < 19) return "";
            const data = [...history.slice(-19), currentPrice];
            const avg = (arr) => arr.reduce((a,b)=>a+b,0) / arr.length;
            const ma5 = avg(data.slice(-5));
            const ma10 = avg(data.slice(-10));
            const ma20 = avg(data.slice(-20));
            
            // çº¢è‰²ä¸Šæ¶¨
            if (ma5 > ma10 && ma10 > ma20) return '<span style="color:#e53935 !important;font-weight:900 !important;font-size:18px;">â†‘</span>';
            // ç»¿è‰²ä¸‹è·Œ
            if (ma5 < ma10 && ma10 < ma20) return '<span style="color:#43a047 !important;font-weight:900 !important;font-size:18px;">â†“</span>';
            
            return ""; 
        }
        
        function forceRefreshTrends() {
            historyCache = {};
            fetchingSet = new Set();
            fetchQueue = [];
            activeRequests = 0;
            updateTable();
            alert("å·²é‡ç½®ï¼Œæ­£åœ¨é‡æ–°æ‹‰å–æ‰€æœ‰è¶‹åŠ¿æ•°æ®...");
        }

        async function updateTable(skipFetch = false) {
            const el = document.getElementById('result'), stat = document.getElementById('status-msg');
            if (stocks.length === 0) { el.innerHTML = '<div style="padding:40px;text-align:center;color:#999;">ğŸ“­ åˆ—è¡¨ä¸ºç©º</div>'; return; }
            
            if (!skipFetch) {
                const secids = stocks.map(s=>getSecid(s.code)).join(',');
                const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?secids=${secids}&fields=f12,f14,f2,f3,f18,f20&invt=2&fltt=2&_=${Date.now()}`;
                try {
                    const res = await fetch(url), json = await res.json();
                    if (json?.data?.diff) {
                        (Array.isArray(json.data.diff)?json.data.diff:Object.values(json.data.diff)).forEach(i => cachedMarketData[i.f12] = i);
                        const t = new Date().toLocaleTimeString(); stat.innerText = `â— æ›´æ–° ${t}`;
                    }
                } catch { if(stat) stat.innerText = "âš ï¸"; }
            }
            
            let missingHistory = 0;
            const data = stocks.map(s => {
                const m = cachedMarketData[s.code.split('.')[0]] || {};
                let cap=0, chg="0.00", valid=false, currentPrice=0;
                if (m.f12) { 
                    let p=parseFloat(m.f2)||parseFloat(m.f18), mc=parseFloat(m.f20); 
                    if(p>0 && mc>0){ cap=mc/100000000; chg=parseFloat(m.f3).toFixed(2); valid=true; currentPrice=p; }
                }
                let pe = { down: '-', up: '-' }, ps = { down: '-', up: '-' };
                if (valid) {
                    if (s.profit && s.lowPE) { pe.down=((s.profit*s.lowPE/cap-1)*100).toFixed(2); pe.up=((s.profit*s.highPE-cap)/cap*100).toFixed(2); }
                    if (s.revenue && s.lowPS) { ps.down=((s.revenue*s.lowPS/cap-1)*100).toFixed(2); ps.up=((s.revenue*s.highPS-cap)/cap*100).toFixed(2); }
                }
                
                if (historyCache[s.code] === undefined && valid) {
                    queueFetchHistory(getSecid(s.code), s.code);
                    missingHistory++;
                }
                
                const trend = getTrendIcon(historyCache[s.code], currentPrice, s.code);
                return { ...s, cap, chg, valid, peRes:pe, psRes:ps, trend };
            });
            
            if(missingHistory > 0) updateProgress(stocks.length - missingHistory, stocks.length);
            renderTable(data); updateCompareBtn();
        }

        let currentVisibleStocks = [];

        function renderTable(data) {
            let rows = data.filter(i => {
                if (onlySelectedMode && !selectedCodes.has(i.code)) return false;
                const k = document.getElementById('findInput').value.toUpperCase(), t = document.getElementById('findTags').value.toLowerCase();
                if (k && !i.code.includes(k) && !i.name.includes(k)) return false;
                if (t && !(i.tags||"").toLowerCase().includes(t)) return false;
                for (let c in columnFilters) {
                    const r = columnFilters[c]; if (!r) continue;
                    if (r.type === 'text') { if (!(i[c]||"").toLowerCase().includes(r.val)) return false; }
                    else {
                        let v = -999999;
                        if (c.includes('pe')) v = parseFloat(i.peRes[c.split('_')[1]]); else if (c.includes('ps')) v = parseFloat(i.psRes[c.split('_')[1]]);
                        if (isNaN(v)) return false;
                        if (r.op==='>'&&!(v>r.val) || r.op==='<'&&!(v<r.val) || r.op==='>='&&!(v>=r.val) || r.op==='<='&&!(v<=r.val) || r.op==='='&&Math.abs(v-r.val)>0.1) return false;
                    }
                }
                return true;
            });
            currentVisibleStocks = rows;
            
            if (sortState.key) {
                rows.sort((a, b) => {
                    if (sortState.key === 'last_update') {
                        const dA = a.logs?.[0]?.date || "";
                        const dB = b.logs?.[0]?.date || "";
                        return sortState.dir === 'desc' ? dB.localeCompare(dA) : dA.localeCompare(dB);
                    }
                    if (sortState.key === 'trend') {
                        const getScore = (o) => {
                            if (o.trend.includes('â†‘')) return 2; 
                            if (o.trend.includes('â†“')) return 0; 
                            return 1; 
                        };
                        return sortState.dir === 'desc' ? getScore(b) - getScore(a) : getScore(a) - getScore(b);
                    }
                    const val = (o) => {
                        if(sortState.key=='chg') return parseFloat(o.chg);
                        if(sortState.key.includes('pe')) return parseFloat(o.peRes[sortState.key.split('_')[1]])||-9999;
                        if(sortState.key.includes('ps')) return parseFloat(o.psRes[sortState.key.split('_')[1]])||-9999;
                        return 0;
                    };
                    return sortState.dir==='desc' ? val(b)-val(a) : val(a)-val(b);
                });
            }
            
            const icon = (k) => `<span class="${columnFilters[k]?'filter-active':''}" onclick="event.stopPropagation();openFilterMenu('${k}',event)" style="cursor:pointer">${columnFilters[k]?'â–¼':'â–½'}</span>`;
            const show = (k) => viewSettings['show'+k.charAt(0).toUpperCase()+k.slice(1)]?'':'col-hidden';
            const allSel = rows.length>0 && rows.every(i=>selectedCodes.has(i.code));

            // Colspan = 3 (Trend+Name+Chg) + Optional(Code+Tags+Cap)
            let html = `<table><thead><tr>
                <th class="th-basic" colspan="${3 + (viewSettings.showCode?1:0) + (viewSettings.showTags?1:0) + (viewSettings.showCap?1:0)}">ğŸ“Š åŸºç¡€è¡Œæƒ…</th>
                <th class="th-pe" colspan="4">ğŸ’° PE (åˆ©æ¶¦)</th><th class="th-ps" colspan="4">ğŸš€ PS (è¥æ”¶)</th>
                <th rowspan="2" class="sortable ${show('update')}" onclick="setSort('last_update')" style="width:70px">ğŸ“… ${getSortIcon('last_update')}</th>
                <th class="th-basic ${show('action')}" rowspan="2">âš™ï¸</th>
                <th class="th-select" rowspan="2" onclick="toggleSelectAll()"><input type="checkbox" ${allSel?'checked':''}></th>
            </tr><tr>
                <th onclick="setSort('trend')" class="sortable" style="width:30px">è¶‹åŠ¿ ${getSortIcon('trend')}</th>
                <th>åç§°</th><th class="${show('code')}">ä»£ç </th><th class="${show('tags')}">å±æ€§ ${icon('tags')}</th>
                <th onclick="setSort('chg')" class="sortable">æ¶¨è·Œ ${getSortIcon('chg')}</th>
                <th class="${show('cap')}">å¸‚å€¼</th>
                <th>å‡€åˆ©</th><th>åˆç†PE</th><th onclick="setSort('pe_down')" class="sortable">ä¸‹% ${icon('pe_down')}</th><th onclick="setSort('pe_up')" class="sortable">ä¸Š% ${icon('pe_up')}</th>
                <th>è¥æ”¶</th><th>åˆç†PS</th><th onclick="setSort('ps_down')" class="sortable">ä¸‹% ${icon('ps_down')}</th><th onclick="setSort('ps_up')" class="sortable">ä¸Š% ${icon('ps_up')}</th>
            </tr></thead><tbody>`;

            if(rows.length===0) html+=`<tr><td colspan="20" style="text-align:center;padding:20px;color:#ccc">æ— æ•°æ®</td></tr>`;
            else rows.forEach(i => {
                const p = (v) => `<span style="color:${parseFloat(v)>=0?'#d32f2f':'#2e7d32'};font-weight:${Math.abs(v)>30?'800':'bold'}">${v==='-'?'-':v+'%'}</span>`;
                const u = i.logs?.[0]?.date ? `<span style="font-size:11px;color:#666;display:block;line-height:1.2">${i.logs[0].date.split(' ')[0]}<br><span style="color:#999;font-size:10px">${i.logs[0].date.split(' ')[1]}</span></span>` : '-';
                
                html += `<tr class="${selectedCodes.has(i.code)?'row-selected':''}">
                    <td style="text-align:center;">${i.trend}</td>
                    <td style="font-weight:600">${i.name}</td><td class="${show('code')}" style="color:#888;font-size:12px">${i.code}</td>
                    <td class="${show('tags')}" style="text-align:left">${(i.tags||"").split(' ').map(t=>t?`<span class="tag-badge">${t}</span>`:'').join('')}</td>
                    <td style="font-weight:bold;color:${parseFloat(i.chg)>=0?'#d32f2f':'#2e7d32'}">${i.chg}%</td>
                    <td class="${show('cap')}" style="font-family:monospace">${i.cap?i.cap.toFixed(2):'-'}</td>
                    <td>${i.profit||'-'}</td><td style="font-size:12px">${i.lowPE||'-'}~${i.highPE||'-'}</td><td>${p(i.peRes.down)}</td><td>${p(i.peRes.up)}</td>
                    <td>${i.revenue||'-'}</td><td style="font-size:12px">${i.lowPS||'-'}~${i.highPS||'-'}</td><td>${p(i.psRes.down)}</td><td>${p(i.psRes.up)}</td>
                    <td class="${show('update')}">${u}</td>
                    <td class="${show('action')}"><button class="btn-log" onclick="showLogs('${i.code}')">ğŸ“</button><button class="btn-edit" onclick="editStock('${i.code}')">âœï¸</button><button class="btn-delete" onclick="openDeleteModal('${i.code}')">âœ•</button></td>
                    <td class="td-select" onclick="toggleSelectRow('${i.code}')"><input type="checkbox" class="row-checkbox" ${selectedCodes.has(i.code)?'checked':''}></td>
                </tr>`;
            });
            document.getElementById('result').innerHTML = html + '</tbody></table>';
        }

        function toggleSelectRow(c) { if(selectedCodes.has(c))selectedCodes.delete(c);else selectedCodes.add(c); updateTable(); }
        function toggleSelectAll() { if(currentVisibleStocks.length===0)return; const all=currentVisibleStocks.every(i=>selectedCodes.has(i.code)); currentVisibleStocks.forEach(i=>all?selectedCodes.delete(i.code):selectedCodes.add(i.code)); updateTable(); }
        function clearAllFilters() { columnFilters={}; document.getElementById('findInput').value=''; document.getElementById('findTags').value=''; if(onlySelectedMode)toggleShowSelected(); updateTable(); }
        function toggleShowSelected() { onlySelectedMode=!onlySelectedMode; const b=document.getElementById('btn-compare'); if(onlySelectedMode){b.classList.add('active');b.innerText="ğŸ”™ å…¨éƒ¨";}else{b.classList.remove('active');updateCompareBtn();} updateTable(); }
        function updateCompareBtn() { if(!onlySelectedMode)document.getElementById('btn-compare').innerText=`ğŸ“Š é€‰ä¸­ (${selectedCodes.size})`; }
        function toggleColumn(c) { const k='show'+c.charAt(0).toUpperCase()+c.slice(1); viewSettings[k]=!viewSettings[k]; localStorage.setItem('viewSettings',JSON.stringify(viewSettings)); updateViewButtons(); updateTable(); }
        function updateViewButtons() { ['code','tags','update','action','cap'].forEach(c => { const b=document.getElementById('btn-toggle-'+c); if(viewSettings['show'+c.charAt(0).toUpperCase()+c.slice(1)])b.classList.add('active');else b.classList.remove('active'); }); }

        function openFilterMenu(k,e) { const m=document.getElementById('filter-menu'); m.style.display='block'; const r=e.target.getBoundingClientRect(); m.style.top=(window.scrollY+r.bottom+5)+'px'; m.style.left=Math.min(window.innerWidth-220, r.left-100)+'px'; document.getElementById('filter-col-key').value=k; const t=k==='tags'; document.getElementById('filter-row-numeric').style.display=t?'none':'flex'; document.getElementById('filter-row-text').style.display=t?'flex':'none'; setTimeout(()=>document.addEventListener('click',closeFilterMenuOutside),0); }
        function closeFilterMenuOutside(e) { const m=document.getElementById('filter-menu'); if(!m.contains(e.target)){m.style.display='none';document.removeEventListener('click',closeFilterMenuOutside);} }
        function confirmFilter() { const k=document.getElementById('filter-col-key').value, t=k==='tags'; if(t){const v=document.getElementById('filter-text-val').value.trim();if(v)columnFilters[k]={type:'text',val:v};else delete columnFilters[k];}else{const o=document.getElementById('filter-op').value,v=document.getElementById('filter-val').value;if(v)columnFilters[k]={type:'num',op:o,val:parseFloat(v)};else delete columnFilters[k];} document.getElementById('filter-menu').style.display='none'; updateTable(); }
        function clearCurrentFilter() { delete columnFilters[document.getElementById('filter-col-key').value]; document.getElementById('filter-menu').style.display='none'; updateTable(); }

        function saveStock() {
            const code=document.getElementById('inCode').value.trim(), name=document.getElementById('inName').value.trim();
            if(!code) { alert("è¯·å…ˆæœç´¢"); return; }
            
            const profit = parseFloat(document.getElementById('inProfit').value)||0;
            const lowPE = parseFloat(document.getElementById('inLowPE').value)||0;
            const highPE = parseFloat(document.getElementById('inHighPE').value)||0;
            const revenue = parseFloat(document.getElementById('inRevenue').value)||0;
            const lowPS = parseFloat(document.getElementById('inLowPS').value)||0;
            const highPS = parseFloat(document.getElementById('inHighPS').value)||0;
            const tags = document.getElementById('inTags').value.trim();
            const note = document.getElementById('inNote').value.trim();

            const idx = stocks.findIndex(i=>i.code===code);
            const now = getNowStr();
            let logContent = "";

            if(idx >= 0) {
                const old = stocks[idx];
                let changes = [];
                if(old.profit !== profit) changes.push(`å‡€åˆ©:${old.profit}â†’${profit}`);
                if(old.lowPE !== lowPE) changes.push(`PEä¸‹:${old.lowPE}â†’${lowPE}`);
                if(old.highPE !== highPE) changes.push(`PEä¸Š:${old.highPE}â†’${highPE}`);
                if(old.revenue !== revenue) changes.push(`è¥æ”¶:${old.revenue}â†’${revenue}`);
                if(old.lowPS !== lowPS) changes.push(`PSä¸‹:${old.lowPS}â†’${lowPS}`);
                if(old.highPS !== highPS) changes.push(`PSä¸Š:${old.highPS}â†’${highPS}`);
                
                if(changes.length > 0) logContent = changes.join('; ');
                else logContent = "æ— å‚æ•°å˜æ›´";
            } else {
                logContent = "é¦–æ¬¡å½•å…¥";
            }

            const s = { 
                code, name, tags, profit, lowPE, highPE, revenue, lowPS, highPS, 
                logs: (idx >= 0 ? stocks[idx].logs : []) 
            };

            if(logContent !== "æ— å‚æ•°å˜æ›´" || note) {
                s.logs.unshift({
                    date: now,
                    content: logContent,
                    note: note
                });
            }

            if(idx >= 0) stocks[idx] = s;
            else stocks.push(s);
            
            saveStorage(); clearInput(); updateTable();
        }

        function searchStockCode() { 
            const n=document.getElementById('inName').value.trim(); if(!n)return; 
            const sc=document.createElement('script'); 
            window.handleSearch=function(d){ if(d?.QuotationCodeTable?.Data?.length){ const r=d.QuotationCodeTable.Data[0]; let s=r.MarketType=="1"?".SH":(r.MarketType=="2"?".SZ":".HK"); if(r.Code.length==6 && !r.MarketType) s=r.Code.startsWith('6')?".SH":".SZ"; document.getElementById('inCode').value=r.Code+s; document.getElementById('inName').value=r.Name; }else alert("æœªæ‰¾åˆ°"); sc.remove(); };
            sc.src=`https://searchapi.eastmoney.com/api/suggest/get?input=${encodeURIComponent(n)}&type=14&token=D43BF722C8E33BD5D50F639205545E43&cb=handleSearch`; document.body.appendChild(sc);
        }

        function editStock(c) {
            if(window.innerWidth<=768) toggleMobileMenu(true); else if(!isPanelOpen) toggleInputPanel();
            document.getElementById('input-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.getElementById('input-container').style.display='block';
            const s=stocks.find(i=>i.code===c); if(!s)return;
            document.getElementById('inName').value=s.name; document.getElementById('inCode').value=s.code; document.getElementById('inTags').value=s.tags||''; 
            document.getElementById('inProfit').value=s.profit||''; document.getElementById('inLowPE').value=s.lowPE||''; document.getElementById('inHighPE').value=s.highPE||'';
            document.getElementById('inRevenue').value=s.revenue||''; document.getElementById('inLowPS').value=s.lowPS||''; document.getElementById('inHighPS').value=s.highPS||''; 
            document.getElementById('btn-save-text').innerText="ğŸ’¾ ä¿®æ”¹";
        }

        function toggleInputPanel() { const c=document.getElementById('input-container'); isPanelOpen=!isPanelOpen; c.style.display=isPanelOpen?'block':'none'; document.getElementById('toggle-btn').innerText=isPanelOpen?'ğŸ”¼ æ”¶èµ·':'â• å½•å…¥/ç®¡ç†'; }
        function clearInput() { document.querySelectorAll('#input-panel input').forEach(i=>i.value=''); document.getElementById('btn-save-text').innerText="ğŸ’¾ ä¿å­˜"; }
        function showLogs(c) { const s=stocks.find(i=>i.code===c); document.getElementById('modal-body').innerHTML=s?.logs?.map((l,i)=>`<div class="log-entry"><div style="display:flex;justify-content:space-between"><span class="log-time">${l.date}</span><span class="log-del-btn" onclick="deleteLog('${c}',${i})">ğŸ—‘ï¸</span></div><div style="font-weight:600">${l.content}</div>${l.note?`<div class="log-note">${l.note}</div>`:''}</div>`).join('')||'æ— '; document.getElementById('log-modal').style.display='flex'; }
        function deleteLog(c,i) { pendingDeleteCode=c; pendingLogIndex=i; document.getElementById('delete-msg').innerText="åˆ æ—¥å¿—?"; document.getElementById('delete-modal').style.display='flex'; }
        window.openDeleteModal=function(c){pendingDeleteCode=c;pendingLogIndex=null;document.getElementById('delete-msg').innerText=`åˆ  ${c}?`;document.getElementById('delete-modal').style.display='flex';};
        window.confirmDeleteAction=function(){if(pendingDeleteCode){if(pendingLogIndex!==null){const s=stocks.find(i=>i.code===pendingDeleteCode);if(s&&s.logs){s.logs.splice(pendingLogIndex,1);saveStorage();showLogs(pendingDeleteCode);updateTable();}pendingLogIndex=null;}else{stocks=stocks.filter(s=>s.code!==pendingDeleteCode);selectedCodes.delete(pendingDeleteCode);saveStorage();updateTable();}}closeDeleteModal();};
        window.closeDeleteModal=function(){document.getElementById('delete-modal').style.display='none';}; function closeLogModal(){document.getElementById('log-modal').style.display='none';}
        function startRealtime() { if(!intervalId) { updateTable(); intervalId=setInterval(updateTable, 5000); } }
        function stopRealtime() { clearInterval(intervalId); intervalId=null; document.getElementById('status-msg').innerText="â¸ æš‚åœ"; }
        function setSort(k) { if(sortState.key===k) sortState.dir=sortState.dir==='desc'?'asc':'desc'; else {sortState.key=k; sortState.dir='desc';} updateTable(); }
        function getSortIcon(k) { return sortState.key!==k?'':(sortState.dir==='desc'?'â¬‡':'â¬†'); }
        function saveStorage() { localStorage.setItem('valuationStocks', JSON.stringify(stocks)); }
        window.onclick=function(e){if(e.target.className==='modal')e.target.style.display='none';}

        updateTable();
    </script>
</body>
</html>
